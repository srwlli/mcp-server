{
  "workorder_id": "WO-CONTEXT-SCHEMA-VERSION-001",
  "feature_name": "schema-version-support",
  "stub_id": "STUB-139",
  "description": "Fix schema version mismatch in coderef-context MCP server. Add backward compatibility for v1.0.0 and v2.0.0 schema formats.",
  "created": "2026-01-20",
  "status": "planning",

  "problem_statement": {
    "summary": "coderef-context MCP tools failing due to schema version mismatch between v1.0.0 (expected by tools) and v2.0.0 (generated by coderef_scan)",
    "pain_points": [
      "coderef_complexity fails with 'str' object has no attribute 'get'",
      "coderef_query fails with 'list' object has no attribute 'items'",
      "Complete failure of AST-based analysis for v2.0.0 schema projects",
      "No schema version detection or backward compatibility"
    ],
    "current_workarounds": "Manual file reading instead of using MCP tools (loses analysis capabilities)"
  },

  "solution_approach": {
    "strategy": "Add schema version detection and support both v1.0.0 and v2.0.0 formats with automatic adaptation",
    "key_decisions": [
      "Detect schema version by checking for 'version' field in data structure",
      "Convert v2.0.0 structures to v1.0.0 format internally for processing",
      "Maintain backward compatibility - no breaking changes",
      "Add comprehensive error logging for debugging"
    ],
    "alternatives_considered": [
      {
        "option": "Force all projects to upgrade to v2.0.0",
        "rejected_because": "Breaking change, would affect all existing projects"
      },
      {
        "option": "Maintain separate codepaths for v1 and v2",
        "rejected_because": "Code duplication, harder to maintain"
      }
    ]
  },

  "implementation_plan": {
    "phases": [
      {
        "phase": 1,
        "name": "Schema Detection Utility",
        "tasks": [
          {
            "task_id": "task_1",
            "description": "Create schema_utils.py with version detection functions",
            "details": [
              "Add detect_schema_version(data) -> str function",
              "Add normalize_index_data(data) -> list function (extracts 'elements' from v2.0.0)",
              "Add normalize_graph_nodes(nodes) -> dict function (converts v2.0.0 list to dict)",
              "Add error logging for schema detection failures"
            ],
            "files_affected": [
              "src/utils/schema_utils.py (NEW)"
            ],
            "estimated_effort": "30 minutes"
          }
        ]
      },
      {
        "phase": 2,
        "name": "Fix coderef_complexity Tool",
        "tasks": [
          {
            "task_id": "task_2",
            "description": "Update coderef_complexity to support both schema versions",
            "details": [
              "Import schema_utils functions",
              "Detect schema version when loading index.json",
              "Normalize v2.0.0 data to v1.0.0 format before processing",
              "Add error handling for schema detection failures",
              "Maintain existing v1.0.0 processing logic unchanged"
            ],
            "files_affected": [
              "src/tools/complexity.py (MODIFIED)"
            ],
            "estimated_effort": "20 minutes"
          }
        ]
      },
      {
        "phase": 3,
        "name": "Fix coderef_query Tool",
        "tasks": [
          {
            "task_id": "task_3",
            "description": "Update coderef_query to support both schema versions",
            "details": [
              "Import schema_utils functions",
              "Detect schema version when loading graph.json",
              "Normalize v2.0.0 nodes list to dict before processing",
              "Add error handling for schema detection failures",
              "Test with GAMES_REGISTRY target (known failure case)"
            ],
            "files_affected": [
              "src/tools/query.py (MODIFIED)"
            ],
            "estimated_effort": "20 minutes"
          }
        ]
      },
      {
        "phase": 4,
        "name": "Fix coderef_impact and coderef_patterns Tools",
        "tasks": [
          {
            "task_id": "task_4",
            "description": "Update coderef_impact to support both schema versions",
            "details": [
              "Import schema_utils functions",
              "Add schema detection and normalization",
              "Test with complex components"
            ],
            "files_affected": [
              "src/tools/impact.py (MODIFIED)"
            ],
            "estimated_effort": "15 minutes"
          },
          {
            "task_id": "task_5",
            "description": "Update coderef_patterns to support both schema versions",
            "details": [
              "Import schema_utils functions",
              "Add schema detection and normalization",
              "Test pattern detection with both schemas"
            ],
            "files_affected": [
              "src/tools/patterns.py (MODIFIED)"
            ],
            "estimated_effort": "15 minutes"
          }
        ]
      },
      {
        "phase": 5,
        "name": "Testing and Validation",
        "tasks": [
          {
            "task_id": "task_6",
            "description": "Create test cases for both schema versions",
            "details": [
              "Create test fixtures for v1.0.0 schema (flat arrays)",
              "Create test fixtures for v2.0.0 schema (nested structure)",
              "Test coderef_complexity with GameClient component",
              "Test coderef_complexity with Tetris component",
              "Test coderef_query with GAMES_REGISTRY target",
              "Verify all 4 tools work with both schemas",
              "Test graceful degradation on invalid schemas"
            ],
            "files_affected": [
              "tests/test_schema_utils.py (NEW)",
              "tests/fixtures/v1_schema/ (NEW)",
              "tests/fixtures/v2_schema/ (NEW)"
            ],
            "estimated_effort": "30 minutes"
          }
        ]
      },
      {
        "phase": 6,
        "name": "Documentation",
        "tasks": [
          {
            "task_id": "task_7",
            "description": "Update CHANGELOG.md and documentation",
            "details": [
              "Add entry to CHANGELOG.md for bugfix",
              "Document schema version support in README.md",
              "Add migration notes for projects using v2.0.0 schema"
            ],
            "files_affected": [
              "CHANGELOG.md (MODIFIED)",
              "README.md (MODIFIED)"
            ],
            "estimated_effort": "15 minutes"
          }
        ]
      }
    ]
  },

  "technical_architecture": {
    "components": [
      {
        "name": "schema_utils.py",
        "type": "utility_module",
        "responsibility": "Schema version detection and normalization",
        "interfaces": [
          "detect_schema_version(data: dict | list) -> str",
          "normalize_index_data(data: dict | list) -> list",
          "normalize_graph_nodes(nodes: dict | list) -> dict"
        ]
      },
      {
        "name": "complexity.py",
        "type": "mcp_tool",
        "responsibility": "Complexity analysis with schema compatibility",
        "changes": "Add schema detection before processing index.json"
      },
      {
        "name": "query.py",
        "type": "mcp_tool",
        "responsibility": "Relationship queries with schema compatibility",
        "changes": "Add schema detection and node normalization before processing graph.json"
      },
      {
        "name": "impact.py",
        "type": "mcp_tool",
        "responsibility": "Impact analysis with schema compatibility",
        "changes": "Add schema detection and normalization"
      },
      {
        "name": "patterns.py",
        "type": "mcp_tool",
        "responsibility": "Pattern detection with schema compatibility",
        "changes": "Add schema detection and normalization"
      }
    ],
    "data_flow": [
      "Tool loads .coderef/index.json or .coderef/graph.json",
      "schema_utils.detect_schema_version(data) detects version",
      "If v2.0.0: schema_utils normalizes data to v1.0.0 format",
      "Tool processes normalized data using existing logic",
      "Results returned to user"
    ]
  },

  "testing_strategy": {
    "unit_tests": [
      "Test detect_schema_version with v1.0.0 fixtures",
      "Test detect_schema_version with v2.0.0 fixtures",
      "Test normalize_index_data with v2.0.0 nested structure",
      "Test normalize_graph_nodes with v2.0.0 list format"
    ],
    "integration_tests": [
      "Test coderef_complexity with v1.0.0 schema project",
      "Test coderef_complexity with v2.0.0 schema project (GameClient, Tetris)",
      "Test coderef_query with v2.0.0 schema project (GAMES_REGISTRY)",
      "Test all 4 tools with both schema versions"
    ],
    "edge_cases": [
      "Invalid schema (missing version field and not flat array)",
      "Corrupted JSON files",
      "Empty elements array in v2.0.0",
      "Missing nodes in graph.json"
    ]
  },

  "dependencies": {
    "internal": [
      "Existing MCP tool infrastructure",
      "JSON file loading utilities"
    ],
    "external": [],
    "blocked_by": [],
    "blocks": []
  },

  "success_criteria": {
    "functional": [
      "coderef_complexity works with both v1.0.0 and v2.0.0 schemas",
      "coderef_query works with both v1.0.0 and v2.0.0 schemas",
      "coderef_impact works with both schemas",
      "coderef_patterns works with both schemas",
      "GameClient complexity analysis succeeds",
      "Tetris complexity analysis succeeds",
      "GAMES_REGISTRY query succeeds"
    ],
    "non_functional": [
      "No breaking changes to existing v1.0.0 projects",
      "Performance impact < 5ms per tool call",
      "Clear error messages for invalid schemas",
      "All tests passing"
    ]
  },

  "risks": {
    "technical": [
      {
        "risk": "Schema normalization introduces bugs",
        "likelihood": "low",
        "mitigation": "Comprehensive test coverage for both schemas"
      },
      {
        "risk": "Performance impact from schema detection",
        "likelihood": "low",
        "mitigation": "Schema detection is O(1) check for 'version' field"
      }
    ],
    "business": []
  },

  "rollout_plan": {
    "phases": [
      {
        "phase": "Development",
        "actions": ["Implement schema_utils", "Update 4 tools", "Add tests"]
      },
      {
        "phase": "Testing",
        "actions": ["Test with v1.0.0 fixtures", "Test with v2.0.0 fixtures", "Test with real projects"]
      },
      {
        "phase": "Deployment",
        "actions": ["Update CHANGELOG.md", "Merge to main", "No restart required (Python reload)"]
      }
    ],
    "rollback_plan": "Git revert commit if critical issues found"
  },

  "estimated_effort": {
    "total_hours": 2.5,
    "breakdown": {
      "schema_utils": "0.5 hours",
      "tool_updates": "1.0 hours",
      "testing": "0.5 hours",
      "documentation": "0.25 hours",
      "validation": "0.25 hours"
    }
  },

  "metadata": {
    "created_by": "Claude Sonnet 4.5",
    "created_date": "2026-01-20",
    "last_updated": "2026-01-20",
    "project": "coderef-context",
    "category": "bugfix",
    "priority": "critical",
    "stub_reference": "STUB-139 (C:\\Users\\willh\\Desktop\\assistant\\coderef\\working\\coderef-context-schema-version-support)"
  }
}
