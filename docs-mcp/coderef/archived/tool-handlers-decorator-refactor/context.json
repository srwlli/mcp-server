{
  "feature_name": "tool-handlers-decorator-refactor",
  "description": "Refactor tool_handlers.py to reduce repetitive boilerplate using decorators and helper abstractions. Target file has 2168 lines with ~35% repetitive error handling, validation, and logging patterns across 21 handlers.",
  "goal": "Reduce code duplication, make it easier to add new handlers, and improve testability through decorator-based abstraction of common patterns.",
  "requirements": [
    "Create @mcp_error_handler decorator to eliminate 600-1000 lines of error handling boilerplate",
    "Create @log_invocation decorator to standardize tool call logging",
    "Create format_success_response() helper function for consistent response formatting",
    "Keep ALL existing architecture (ErrorResponse, validation.py, logger_config.py)",
    "Reduce total lines from 2168 to ~1400-1600 (25-35% reduction)",
    "Test decorators and helpers independently with comprehensive unit tests",
    "Keep existing handler tests unchanged to verify backward compatibility",
    "Maintain 100% backward compatibility - no changes to MCP tool signatures, parameters, or response formats",
    "Preserve all error response formats and structures",
    "Preserve error logging context (template_name, project_path, etc.) for debugging",
    "Maintain async performance - decorators must support async functions properly with <1ms overhead",
    "Maintain all code reference tags (ARCH-003, REF-003, QUA-002, etc.) and add new tags for decorators",
    "Add full type hints to decorators using typing.ParamSpec and typing.Concatenate",
    "Update CLAUDE.md documentation with decorator pattern explanation",
    "Update 'Adding New Tools' section in CLAUDE.md with decorator examples",
    "Add comprehensive docstrings explaining the pattern",
    "Must be reviewer-friendly with clear commit messages and passing tests"
  ],
  "implementation_approach": {
    "strategy": "Mix of decorators and helpers (flexible approach)",
    "phase_1": "Refactor in tool_handlers.py - Add decorators at top, update all 21 handlers, test everything works",
    "phase_2": "Extract to separate files - Move decorators to handler_decorators.py, move helpers to handler_helpers.py, update imports"
  },
  "out_of_scope": [
    "Changing MCP tool names, parameters, or external API",
    "Modifying ErrorResponse factory patterns (ARCH-001)",
    "Changing validation.py functions (REF-003)",
    "Modifying logger_config.py (ARCH-003)",
    "Creating base classes for handlers",
    "Over-engineering with complex abstractions"
  ],
  "constraints": [
    "Must maintain 100% backward compatibility - external MCP API stays identical",
    "Must preserve existing error response formats and structures",
    "Must preserve logging behavior and context (log messages identical, timing/order may vary slightly)",
    "Must be reviewer-friendly - clear commits, good descriptions, all tests passing",
    "Two-phase implementation - refactor in-place first, then extract to modules",
    "No deadlines - prioritize best quality over speed",
    "Must maintain async compatibility and performance"
  ],
  "technical_details": {
    "target_file": "tool_handlers.py",
    "current_size": "2168 lines",
    "handler_count": 21,
    "boilerplate_estimate": "35% (~600-800 lines)",
    "target_size": "~1400-1600 lines",
    "patterns_to_abstract": [
      "Error handling (try/except blocks with 4-6 exception types)",
      "Tool invocation logging (log_tool_call)",
      "Input validation (validate_project_path_input, etc.)",
      "Response formatting (success messages with consistent structure)"
    ],
    "new_files_phase_2": [
      "handler_decorators.py",
      "handler_helpers.py"
    ],
    "existing_patterns_to_preserve": [
      "error_responses.py (ARCH-001)",
      "validation.py (REF-003)",
      "logger_config.py (ARCH-003)",
      "type_defs.py (QUA-001)",
      "constants.py (REF-002, QUA-003)"
    ]
  },
  "testing_strategy": {
    "approach": "Add new tests for decorators + keep existing handler tests",
    "new_test_files": [
      "test_handler_decorators.py - Unit tests for @mcp_error_handler and @log_invocation",
      "test_handler_helpers.py - Unit tests for format_success_response()"
    ],
    "existing_tests": "Keep unchanged to verify backward compatibility",
    "coverage_target": "100% coverage for new decorators and helpers",
    "test_cases": [
      "Test @mcp_error_handler catches ValueError, PermissionError, FileNotFoundError, Exception",
      "Test @log_invocation logs tool name and argument keys",
      "Test decorators preserve async function behavior",
      "Test decorators maintain error context (handler name, args)",
      "Test format_success_response generates consistent output",
      "Test all 21 handlers still pass existing tests"
    ]
  },
  "success_criteria": [
    "Reduced boilerplate by 25-35% (~600-800 lines)",
    "All 21 handlers refactored to use decorators",
    "100% backward compatibility maintained - all existing tests pass",
    "New decorators have 100% test coverage",
    "Performance overhead <1ms per handler",
    "CLAUDE.md updated with decorator pattern documentation",
    "Code reference tags maintained and new tags added",
    "Full type hints on all decorators",
    "Comprehensive docstrings added",
    "Two-phase implementation complete (refactor + extract)",
    "PR is reviewer-friendly and easy to understand",
    "Sets clear pattern for adding future handlers"
  ],
  "quality_targets": {
    "priority": "best_quality",
    "timeline": "no_deadlines",
    "completeness": "all_requirements_must_have_should_have_nice_to_have",
    "documentation": "comprehensive",
    "testing": "thorough",
    "code_quality": "reference_quality_showcase"
  }
}
