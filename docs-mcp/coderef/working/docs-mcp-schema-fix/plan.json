{
  "META_DOCUMENTATION": {
    "feature_name": "docs-mcp-schema-fix",
    "schema_version": "1.0.0",
    "version": "1.0.0",
    "status": "complete",
    "generated_by": "Lloyd - AI Project Coordinator",
    "generated_at": "2025-12-03"
  },
  "UNIVERSAL_PLANNING_STRUCTURE": {
    "0_preparation": {
      "project_type": "refactor",
      "tech_stack": {
        "language": "Python 3.11+",
        "framework": "MCP SDK",
        "validation": "jsonschema"
      },
      "key_dependencies": [
        "jsonschema (for schema validation)",
        "mcp (MCP SDK)"
      ],
      "project_structure": {
        "schemas/": "JSON Schema definitions",
        "tool_handlers.py": "MCP tool handlers",
        "handler_helpers.py": "Shared helper functions",
        "server.py": "MCP server entry point"
      }
    },
    "1_executive_summary": {
      "feature_name": "Schema-First Planning Architecture",
      "description": "Implement schema-first design for plan.json to ensure consistent structure between create_plan and all downstream consumers",
      "goal": "Eliminate schema mismatch errors by enforcing a JSON schema contract across all planning tools",
      "estimated_complexity": "medium",
      "estimated_tasks": 8,
      "key_deliverables": [
        "plan.schema.json - Single source of truth",
        "Schema validation in validate_plan",
        "Updated generate_deliverables_template handler",
        "Schema-aware create_plan instructions",
        "Clear error messages on violations"
      ]
    },
    "2_risk_assessment": {
      "technical_risks": [
        {
          "risk": "Existing plans don't match new schema",
          "severity": "medium",
          "mitigation": "Add schema_version field, handle missing fields gracefully with defaults"
        },
        {
          "risk": "jsonschema library not installed",
          "severity": "low",
          "mitigation": "Add to requirements, graceful fallback if missing"
        }
      ],
      "scope_risks": [
        {
          "risk": "Schema too strict, rejects valid variations",
          "severity": "medium",
          "mitigation": "Use additionalProperties: true where flexibility needed"
        }
      ],
      "dependency_risks": []
    },
    "3_current_state_analysis": {
      "existing_files": [
        "tool_handlers.py",
        "handler_helpers.py",
        "server.py"
      ],
      "files_to_create": [
        {
          "path": "schemas/plan.schema.json",
          "purpose": "JSON Schema defining plan.json structure - single source of truth"
        },
        {
          "path": "schema_validator.py",
          "purpose": "Schema validation utilities with clear error messages"
        }
      ],
      "files_to_modify": [
        {
          "path": "tool_handlers.py",
          "changes": "Update handle_generate_deliverables_template to use schema-defined structure"
        },
        {
          "path": "tool_handlers.py",
          "changes": "Update handle_validate_plan to validate against schema first"
        },
        {
          "path": "tool_handlers.py",
          "changes": "Update handle_create_plan to return schema with instructions"
        }
      ],
      "dependencies_to_add": [
        "jsonschema>=4.0.0"
      ]
    },
    "4_key_features": {
      "features": [
        {
          "id": "F1",
          "name": "Schema Definition",
          "description": "Create plan.schema.json as single source of truth for plan structure",
          "priority": "critical",
          "tasks": ["SCHEMA-001"]
        },
        {
          "id": "F2",
          "name": "Schema Validation",
          "description": "Add schema validation to validate_plan before scoring",
          "priority": "critical",
          "tasks": ["VALIDATE-001", "VALIDATE-002"]
        },
        {
          "id": "F3",
          "name": "Deliverables Fix",
          "description": "Update generate_deliverables_template to handle schema-defined structure",
          "priority": "critical",
          "tasks": ["DELIVER-001"]
        },
        {
          "id": "F4",
          "name": "Create Plan Update",
          "description": "Update create_plan to return schema with instructions",
          "priority": "high",
          "tasks": ["CREATE-001"]
        },
        {
          "id": "F5",
          "name": "Error Messages",
          "description": "Provide clear, actionable error messages on schema violations",
          "priority": "high",
          "tasks": ["ERROR-001"]
        }
      ]
    },
    "5_task_id_system": {
      "workorder": {
        "id": "WO-DOCS-MCP-SCHEMA-FIX-001",
        "name": "Schema-First Planning Architecture",
        "feature_dir": "coderef/working/docs-mcp-schema-fix"
      },
      "tasks": [
        {
          "id": "SCHEMA-001",
          "workorder_id": "WO-DOCS-MCP-SCHEMA-FIX-001",
          "description": "Create plan.schema.json with complete structure definition",
          "type": "setup",
          "files": ["schemas/plan.schema.json"],
          "estimated_loc": 200,
          "dependencies": []
        },
        {
          "id": "VALIDATE-001",
          "workorder_id": "WO-DOCS-MCP-SCHEMA-FIX-001",
          "description": "Create schema_validator.py with validation utilities",
          "type": "feature",
          "files": ["schema_validator.py"],
          "estimated_loc": 80,
          "dependencies": ["SCHEMA-001"]
        },
        {
          "id": "VALIDATE-002",
          "workorder_id": "WO-DOCS-MCP-SCHEMA-FIX-001",
          "description": "Update handle_validate_plan to validate schema before scoring",
          "type": "refactor",
          "files": ["tool_handlers.py"],
          "estimated_loc": 30,
          "dependencies": ["VALIDATE-001"]
        },
        {
          "id": "DELIVER-001",
          "workorder_id": "WO-DOCS-MCP-SCHEMA-FIX-001",
          "description": "Fix handle_generate_deliverables_template to use schema structure",
          "type": "refactor",
          "files": ["tool_handlers.py"],
          "estimated_loc": 50,
          "dependencies": ["SCHEMA-001"]
        },
        {
          "id": "CREATE-001",
          "workorder_id": "WO-DOCS-MCP-SCHEMA-FIX-001",
          "description": "Update handle_create_plan to return schema with instructions",
          "type": "refactor",
          "files": ["tool_handlers.py"],
          "estimated_loc": 20,
          "dependencies": ["SCHEMA-001"]
        },
        {
          "id": "ERROR-001",
          "workorder_id": "WO-DOCS-MCP-SCHEMA-FIX-001",
          "description": "Implement clear schema validation error messages",
          "type": "feature",
          "files": ["schema_validator.py"],
          "estimated_loc": 40,
          "dependencies": ["VALIDATE-001"]
        },
        {
          "id": "TEST-001",
          "workorder_id": "WO-DOCS-MCP-SCHEMA-FIX-001",
          "description": "Add unit tests for schema validation",
          "type": "test",
          "files": ["tests/unit/test_schema_validator.py"],
          "estimated_loc": 100,
          "dependencies": ["VALIDATE-001", "ERROR-001"]
        },
        {
          "id": "DOCS-001",
          "workorder_id": "WO-DOCS-MCP-SCHEMA-FIX-001",
          "description": "Update documentation with schema requirements",
          "type": "docs",
          "files": ["README.md"],
          "estimated_loc": 30,
          "dependencies": ["SCHEMA-001"]
        }
      ]
    },
    "6_implementation_phases": {
      "phases": [
        {
          "phase": 1,
          "name": "Schema Foundation",
          "description": "Create the schema and validation utilities",
          "tasks": ["SCHEMA-001", "VALIDATE-001", "ERROR-001"],
          "deliverables": [
            "plan.schema.json with complete structure",
            "schema_validator.py with validation functions",
            "Clear error message formatting"
          ]
        },
        {
          "phase": 2,
          "name": "Handler Updates",
          "description": "Update all planning tool handlers to use schema",
          "tasks": ["VALIDATE-002", "DELIVER-001", "CREATE-001"],
          "deliverables": [
            "validate_plan uses schema validation",
            "generate_deliverables works with schema structure",
            "create_plan returns schema to AI"
          ]
        },
        {
          "phase": 3,
          "name": "Testing & Docs",
          "description": "Add tests and update documentation",
          "tasks": ["TEST-001", "DOCS-001"],
          "deliverables": [
            "Unit tests for schema validation",
            "Updated README with schema info"
          ]
        }
      ]
    },
    "7_testing_strategy": {
      "unit_tests": [
        {
          "target": "schema_validator.py",
          "tests": [
            "Valid plan passes validation",
            "Missing required fields fails with clear message",
            "Invalid field types fail with clear message",
            "Schema version mismatch warning"
          ]
        }
      ],
      "integration_tests": [
        {
          "target": "generate_deliverables_template",
          "tests": [
            "Generates correct markdown from schema-compliant plan",
            "Handles all phase structures correctly",
            "Task IDs render properly"
          ]
        }
      ],
      "e2e_tests": [
        {
          "flow": "Full planning workflow",
          "steps": [
            "gather_context creates context.json",
            "create_plan returns schema + instructions",
            "AI generates schema-compliant plan",
            "validate_plan validates schema first",
            "generate_deliverables succeeds"
          ]
        }
      ],
      "manual_testing": [
        "Test with existing plans to verify backward compatibility",
        "Test error messages are clear and actionable"
      ]
    },
    "8_success_criteria": {
      "functional": [
        "generate_deliverables_template works without schema errors",
        "validate_plan validates schema before scoring",
        "create_plan returns schema for AI to follow",
        "Clear error messages identify exact schema violations"
      ],
      "performance": [
        "Schema validation adds < 100ms to validate_plan"
      ],
      "quality": [
        "All planning tools use single schema source of truth",
        "Existing plans with missing fields handled gracefully",
        "No breaking changes to MCP tool signatures"
      ]
    },
    "9_implementation_checklist": {
      "phase_1_schema_foundation": [
        "[ ] SCHEMA-001: Create plan.schema.json",
        "[ ] VALIDATE-001: Create schema_validator.py",
        "[ ] ERROR-001: Implement clear error messages"
      ],
      "phase_2_handler_updates": [
        "[ ] VALIDATE-002: Update handle_validate_plan",
        "[ ] DELIVER-001: Fix handle_generate_deliverables_template",
        "[ ] CREATE-001: Update handle_create_plan"
      ],
      "phase_3_testing_docs": [
        "[ ] TEST-001: Add unit tests",
        "[ ] DOCS-001: Update documentation"
      ]
    }
  }
}
