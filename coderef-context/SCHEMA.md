# CodeRef Schema Documentation

**Version:** 2.0.0 (Production Standard)
**Generated By:** coderef-dashboard/packages/coderef-core
**Last Updated:** 2026-01-22

---

## Overview

This document defines the `.coderef/` schema formats used by the CodeRef ecosystem. The production standard is **v2.0.0**, generated by the coderef-dashboard scanner.

---

## v2.0.0 Schema (Production Standard)

### Status
- **Production Standard** - All new projects use this format
- **Generated by:** `coderef-dashboard/packages/coderef-core/src/fileGeneration/saveIndex.ts`
- **Supported by:** coderef-context MCP server v2.1.1+

### index.json Format

```json
{
  "version": "2.0.0",
  "generatedAt": "2026-01-22T10:00:00.000Z",
  "projectPath": "/absolute/path/to/project",
  "totalElements": 780,
  "elementsByType": {
    "component": 350,
    "method": 306,
    "function": 77,
    "constant": 27,
    "hook": 16,
    "class": 4
  },
  "elements": [
    {
      "type": "function",
      "name": "authenticateUser",
      "file": "/absolute/path/to/file.ts",
      "line": 42,
      "exported": true
    },
    {
      "type": "class",
      "name": "AuthService",
      "file": "/absolute/path/to/service.ts",
      "line": 15,
      "exported": true
    }
  ]
}
```

#### Root Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `version` | string | Yes | Schema version ("2.0.0") |
| `generatedAt` | string | Yes | ISO timestamp of generation |
| `projectPath` | string | Yes | Absolute path to project root |
| `totalElements` | number | Yes | Total number of code elements |
| `elementsByType` | object | Yes | Element counts by type |
| `elements` | array | Yes | Array of code elements |

#### Element Object

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `type` | string | Yes | Element type (function, class, component, etc) |
| `name` | string | Yes | Element name/identifier |
| `file` | string | Yes | Absolute file path |
| `line` | number | Yes | Line number in file |
| `exported` | boolean | No | Whether element is exported |
| `parameters` | array | No | Function/method parameters |

#### Element Types

- `function` - Standalone function
- `class` - Class definition
- `component` - React/UI component
- `hook` - React hook (e.g., useAuth)
- `method` - Class method
- `constant` - Named constant
- `interface` - TypeScript interface
- `type` - TypeScript type alias

### graph.json Format

```json
{
  "version": "2.0.0",
  "nodes": [
    {
      "id": "AuthService",
      "name": "AuthService",
      "type": "class",
      "file": "/path/to/service.ts",
      "line": 15
    },
    {
      "id": "authenticateUser",
      "name": "authenticateUser",
      "type": "function",
      "file": "/path/to/auth.ts",
      "line": 42
    }
  ],
  "edges": {
    "AuthService": ["authenticateUser"],
    "authenticateUser": ["validateToken", "getUserFromDB"]
  }
}
```

#### Root Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `version` | string | Yes | Schema version ("2.0.0") |
| `nodes` | array | Yes | Array of graph nodes |
| `edges` | object | Yes | Dependency edges (adjacency list) |

#### Node Object

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `id` | string | Yes | Unique node identifier |
| `name` | string | Yes | Element name |
| `type` | string | Yes | Element type |
| `file` | string | Yes | Absolute file path |
| `line` | number | Yes | Line number |

#### Edges Format

The `edges` field is an adjacency list where:
- Key: Node ID (dependent)
- Value: Array of node IDs (dependencies)

Example: `"AuthService": ["authenticateUser"]` means AuthService depends on authenticateUser.

---

## v1.0.0 Schema (Legacy)

### Status
- **Deprecated** - Backward compatibility only
- **Not recommended** for new projects
- **Supported by:** coderef-context MCP server v2.1.1+ (automatic normalization)

### index.json Format (Legacy)

```json
[
  {
    "type": "function",
    "name": "authenticateUser",
    "file": "/path/to/file.ts",
    "line": 42,
    "exported": true
  },
  {
    "type": "class",
    "name": "AuthService",
    "file": "/path/to/service.ts",
    "line": 15,
    "exported": true
  }
]
```

**Differences from v2.0.0:**
- Flat array (no metadata wrapper)
- No `version` field
- No timestamp, project path, or element counts
- Less self-documenting

### graph.json Format (Legacy)

```json
{
  "nodes": {
    "AuthService": {
      "id": "AuthService",
      "name": "AuthService",
      "type": "class"
    },
    "authenticateUser": {
      "id": "authenticateUser",
      "name": "authenticateUser",
      "type": "function"
    }
  },
  "edges": {
    "AuthService": ["authenticateUser"]
  }
}
```

**Differences from v2.0.0:**
- Nodes as dict/object (not array)
- Keys are node IDs
- No file paths or line numbers in nodes

---

## Schema Migration

### Automatic Normalization

The coderef-context MCP server (v2.1.1+) automatically normalizes both formats:

```python
# src/schema_utils.py

def normalize_index_data(data):
    """
    Automatically detects and normalizes:
    - v2.0.0: Extracts 'elements' array
    - v1.0.0: Returns as-is (already flat array)
    """
    if isinstance(data, dict) and 'version' in data:
        return data['elements']  # v2.0.0
    return data  # v1.0.0

def normalize_graph_nodes(nodes):
    """
    Automatically detects and normalizes:
    - v2.0.0: Converts nodes array to dict
    - v1.0.0: Returns as-is (already dict)
    """
    if isinstance(nodes, list):
        return {node['id']: node for node in nodes}  # v2.0.0
    return nodes  # v1.0.0
```

### No Action Required

**For existing projects:** The MCP server handles both formats transparently.
**For new projects:** Use coderef-dashboard scanner (generates v2.0.0 by default).

---

## Production Scanner

### Location
`C:\Users\willh\Desktop\coderef-dashboard\packages\coderef-core\src\fileGeneration\saveIndex.ts`

### Key Code

```typescript
const indexData = {
  version: '2.0.0',
  generatedAt: new Date().toISOString(),
  projectPath,
  totalElements: elements.length,
  elementsByType: getElementCountsByType(elements),
  elements,
};

fs.writeFileSync(indexPath, JSON.stringify(indexData, null, 2));
```

### Usage

```bash
cd C:\Users\willh\Desktop\coderef-dashboard\packages\coderef-core
npm run scan -- --project-path /path/to/your/project
```

---

## Benefits of v2.0.0

1. **Self-Documenting** - Includes timestamp, project path, element counts
2. **AI-Friendly** - Metadata helps AI agents understand scan context
3. **Versioned** - Explicit version field enables future schema evolution
4. **Statistics** - Element counts by type for quick overview
5. **Timestamped** - Track when analysis was performed
6. **Consistent** - Same structure across all projects

---

## Validation

### Schema Compliance

The v2.0.0 schema enforces:
- Version string must be "2.0.0"
- GeneratedAt must be ISO 8601 timestamp
- ProjectPath must be absolute path
- TotalElements must match elements.length
- Elements array must contain valid element objects

### Testing

```bash
# Test schema normalization
pytest tests/test_schema_utils.py -v

# Verify production file
python -c "
from src.schema_utils import detect_schema_version, normalize_index_data
import json

with open('.coderef/index.json') as f:
    data = json.load(f)
    version = detect_schema_version(data)
    normalized = normalize_index_data(data)
    print(f'Version: {version}, Elements: {len(normalized)}')
"
```

---

## References

- **Production Scanner:** `coderef-dashboard/packages/coderef-core/src/fileGeneration/saveIndex.ts`
- **Normalization Logic:** `coderef-context/src/schema_utils.py`
- **Test Suite:** `coderef-context/tests/test_schema_utils.py`
- **MCP Server:** `coderef-context/src/coderef_reader.py`

---

**Last Updated:** 2026-01-22
**Schema Version:** 2.0.0
**Status:** âœ… Production Standard
