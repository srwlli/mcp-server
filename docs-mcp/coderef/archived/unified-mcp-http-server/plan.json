{
  "META_DOCUMENTATION": {
    "plan_id": "WO-UNIFIED-MCP-HTTP-SERVER-001",
    "plan_name": "Unified MCP HTTP Server",
    "feature_name": "unified-mcp-http-server",
    "version": "1.0.0",
    "status": "ready_for_implementation",
    "generated_at": "2025-10-20T23:00:00Z",
    "estimated_effort": "3-4 hours",
    "workorder_id": "WO-UNIFIED-MCP-HTTP-SERVER-001",
    "has_context": false,
    "has_analysis": false
  },

  "UNIVERSAL_PLANNING_STRUCTURE": {
    "0_preparation": {
      "foundation_docs": {
        "available": ["README.md", "CLAUDE.md", "USER-GUIDE.md", "CHATGPT-INTEGRATION-TROUBLESHOOTING.md"],
        "missing": []
      },
      "coding_standards": {
        "available": [],
        "missing": ["No project-specific standards extracted yet"]
      },
      "reference_components": {
        "primary": "http_server.py - Existing Flask HTTP wrapper for docs-mcp with /health, /tools, /sse, /mcp endpoints",
        "secondary": [
          "docs-mcp/server.py - MCP server with 33 tools",
          "coderef-mcp/server.py - Code reference tools",
          "hello-world-mcp/server.py - Test/demo server",
          "personas-mcp/server.py - Persona management tools"
        ]
      },
      "key_patterns_identified": [
        "Flask route pattern: @app.route('/endpoint', methods=['GET/POST'])",
        "MCP protocol: JSON-RPC 2.0 with initialize, tools/list, tools/call methods",
        "Async handler pattern: asyncio.run() for calling async MCP functions",
        "Tool registry pattern: TOOL_HANDLERS dict mapping tool names to functions",
        "OpenRPC transformation: _build_openrpc_spec() and _transform_tool_to_openrpc_method()",
        "Error handling: Try/except with JSON-RPC error responses"
      ],
      "technology_stack": {
        "language": "Python 3.11+",
        "framework": "Flask 3.0.0",
        "server": "gunicorn on Railway.app",
        "protocol": "MCP (Model Context Protocol) over JSON-RPC 2.0",
        "transport": "HTTP with SSE support"
      },
      "gaps_and_risks": [
        "No unified server import pattern exists (currently only imports docs-mcp)",
        "Tool name collisions possible between different MCP servers",
        "Import paths need sys.path manipulation for sibling directories",
        "Unknown: How many tools each non-docs server has",
        "Unknown: Whether all servers follow same async pattern",
        "Performance: Loading 4 servers at startup may increase initialization time",
        "Deployment: Railway needs access to all 4 server directories"
      ]
    },

    "1_executive_summary": {
      "purpose": "Modify http_server.py to import and expose all 4 MCP servers (docs-mcp, coderef-mcp, hello-world-mcp, personas-mcp) through a unified HTTP endpoint, enabling ChatGPT to access all available tools instead of just docs-mcp's 33 tools",
      "value_proposition": [
        "Single deployment exposes all MCP servers - no need to deploy each separately",
        "ChatGPT gets access to full tool ecosystem (docs + code analysis + personas + testing)",
        "Automatic tool discovery - add new MCP servers without manual configuration",
        "Maintains backward compatibility - existing docs-mcp integration still works",
        "Eliminates tool name prefixing - unified namespace across all servers"
      ],
      "real_world_analogy": "Like consolidating multiple API microservices behind a single API gateway - clients only need to connect once to access all services",
      "use_case": "ChatGPT connects to https://docs-mcp-production.up.railway.app/mcp → receives combined tool list from all 4 servers → can invoke any tool regardless of which server owns it → http_server.py routes the call to the correct server",
      "output": "Modified http_server.py (~200 lines added) that dynamically imports all MCP servers in ../[server-name]/ directories, merges their tool lists, and routes tool calls to the appropriate server"
    },

    "2_risk_assessment": {
      "overall_risk": "medium",
      "complexity": "medium (1 file modified, ~200 lines added, requires dynamic imports and routing logic)",
      "scope": "Medium - 1 file (http_server.py), adds multi-server import system, adds tool routing dispatcher",
      "file_system_risk": "low (reads sibling directories, no writes)",
      "dependencies": {
        "existing_internal": [
          "docs-mcp/server.py (already imported)",
          "coderef-mcp/server.py (need to import)",
          "hello-world-mcp/server.py (need to import)",
          "personas-mcp/server.py (need to import)"
        ],
        "existing_external": [
          "flask (already installed)",
          "mcp (already installed)",
          "asyncio (stdlib)"
        ],
        "new_external": [],
        "new_internal": []
      },
      "performance_concerns": [
        "Startup time: Loading 4 servers instead of 1 may increase by 200-400ms (acceptable)",
        "Memory footprint: 4 servers in memory instead of 1 (estimated +50-100MB)",
        "Tool discovery: 4x list_tools() calls on /tools endpoint (acceptable, infrequent)",
        "Tool routing: O(1) dict lookup per invocation (negligible overhead)"
      ],
      "security_considerations": [
        "Import security: Only import from known sibling directories (no user input)",
        "Tool namespace: Validate no duplicate tool names across servers",
        "Error isolation: One server's import failure shouldn't crash entire app",
        "Access control: All servers exposed equally (no per-server auth needed initially)"
      ],
      "breaking_changes": "none - purely additive, existing docs-mcp integration unchanged",
      "rollback_plan": "Revert http_server.py to current version if issues arise"
    },

    "3_current_state_analysis": {
      "affected_files": [
        "MODIFIED: http_server.py (~200 lines added for multi-server import and routing)",
        "READ-ONLY: docs-mcp/server.py (already imported successfully)",
        "READ-ONLY: coderef-mcp/server.py (need to verify importable)",
        "READ-ONLY: hello-world-mcp/server.py (need to verify importable)",
        "READ-ONLY: personas-mcp/server.py (need to verify importable)"
      ],
      "dependencies": {
        "existing_internal": {
          "http_server.py": "Current Flask wrapper - imports only docs-mcp/server.py",
          "docs-mcp/server.py": "33 tools for documentation/changelog/planning/inventory",
          "coderef-mcp/server.py": "Code reference and analysis tools",
          "hello-world-mcp/server.py": "Test/demo MCP server",
          "personas-mcp/server.py": "Persona management tools"
        },
        "existing_external": {
          "flask": "Web framework for HTTP server",
          "mcp": "Model Context Protocol library",
          "asyncio": "Async I/O for calling MCP server methods"
        }
      },
      "architecture_context": "HTTP server (http_server.py) acts as transport adapter, converting HTTP requests to MCP protocol calls. Currently imports only docs-mcp/server.py and exposes its 33 tools. Need to extend to import all 4 MCP servers from sibling directories, merge their tool lists, and route tool invocations to the correct server based on tool name. Each MCP server remains independent - HTTP layer is just a unified gateway."
    },

    "4_key_features": {
      "primary_features": [
        "Dynamic multi-server discovery: Scan ../[server-name]/ directories for MCP servers",
        "Unified tool registry: Merge tool lists from all 4 servers into single namespace",
        "Intelligent routing: Map tool names to their owning server for correct dispatch",
        "Graceful degradation: If one server fails to import, others still work",
        "Duplicate detection: Warn if multiple servers define same tool name"
      ],
      "secondary_features": [
        "Import diagnostics: Log which servers loaded successfully vs failed",
        "Tool count reporting: Show breakdown by server (docs-mcp: 33, coderef-mcp: X, etc.)",
        "Health check updates: /health endpoint shows status of all 4 servers",
        "OpenRPC spec merging: /tools endpoint returns combined spec from all servers",
        "Backward compatibility: Existing docs-mcp clients unaffected"
      ],
      "edge_case_handling": [
        "Server import failure: Log error, continue with remaining servers",
        "Duplicate tool names: Use first occurrence, log warning about collision",
        "Missing server directory: Skip gracefully, log info message",
        "Empty server (no tools): Include in count but no tools added",
        "Server has no list_tools(): Log error, skip that server"
      ],
      "configuration_options": [
        "SERVER_DIRS: List of server directory names to scan (configurable)",
        "REQUIRE_ALL_SERVERS: Boolean flag - fail if any server missing (default: false)"
      ]
    },

    "5_task_id_system": {
      "workorder": {
        "id": "WO-UNIFIED-MCP-HTTP-SERVER-001",
        "name": "Unified MCP HTTP Server",
        "feature_dir": "coderef/working/unified-mcp-http-server"
      },
      "tasks": [
        {
          "id": "EXPLORE-001",
          "workorder_id": "WO-UNIFIED-MCP-HTTP-SERVER-001",
          "description": "Verify all 4 MCP server directories exist and have server.py files",
          "details": "Check ../docs-mcp/, ../coderef-mcp/, ../hello-world-mcp/, ../personas-mcp/ exist"
        },
        {
          "id": "EXPLORE-002",
          "workorder_id": "WO-UNIFIED-MCP-HTTP-SERVER-001",
          "description": "Test importing each server module individually to identify issues",
          "details": "Run test script that imports each server.py and calls list_tools()"
        },
        {
          "id": "IMPL-001",
          "workorder_id": "WO-UNIFIED-MCP-HTTP-SERVER-001",
          "description": "Add SERVER_DIRS constant with list of MCP server directory names",
          "details": "Define SERVER_DIRS = ['docs-mcp', 'coderef-mcp', 'hello-world-mcp', 'personas-mcp']"
        },
        {
          "id": "IMPL-002",
          "workorder_id": "WO-UNIFIED-MCP-HTTP-SERVER-001",
          "description": "Create _load_mcp_servers() function to dynamically import all servers",
          "details": "Function adds parent dir to sys.path, imports each server module, returns dict of {server_name: module}"
        },
        {
          "id": "IMPL-003",
          "workorder_id": "WO-UNIFIED-MCP-HTTP-SERVER-001",
          "description": "Create _build_unified_tool_registry() function to merge tools from all servers",
          "details": "Calls list_tools() on each server, merges into single dict, detects duplicates"
        },
        {
          "id": "IMPL-004",
          "workorder_id": "WO-UNIFIED-MCP-HTTP-SERVER-001",
          "description": "Create _route_tool_call() function to dispatch tool calls to correct server",
          "details": "Looks up tool name in registry, calls appropriate server's handler"
        },
        {
          "id": "IMPL-005",
          "workorder_id": "WO-UNIFIED-MCP-HTTP-SERVER-001",
          "description": "Update /tools endpoint to call all servers and merge OpenRPC specs",
          "details": "Loop through loaded servers, call list_tools() on each, merge methods arrays"
        },
        {
          "id": "IMPL-006",
          "workorder_id": "WO-UNIFIED-MCP-HTTP-SERVER-001",
          "description": "Update /mcp tools/list to return unified tool list from all servers",
          "details": "Replace current _build_mcp_tools_list() with unified registry call"
        },
        {
          "id": "IMPL-007",
          "workorder_id": "WO-UNIFIED-MCP-HTTP-SERVER-001",
          "description": "Update /mcp tool execution to route calls through _route_tool_call()",
          "details": "Replace direct TOOL_HANDLERS lookup with router function"
        },
        {
          "id": "IMPL-008",
          "workorder_id": "WO-UNIFIED-MCP-HTTP-SERVER-001",
          "description": "Update /health endpoint to show status of all 4 servers",
          "details": "Add servers_loaded: {docs-mcp: true, coderef-mcp: true, ...} field"
        },
        {
          "id": "IMPL-009",
          "workorder_id": "WO-UNIFIED-MCP-HTTP-SERVER-001",
          "description": "Update root / endpoint to show total tools across all servers",
          "details": "Update total_tools count and add breakdown by server"
        },
        {
          "id": "TEST-001",
          "workorder_id": "WO-UNIFIED-MCP-HTTP-SERVER-001",
          "description": "Test /tools endpoint returns OpenRPC spec with tools from all servers",
          "details": "curl http://localhost:5000/tools | jq '.methods | length' (should be >33)"
        },
        {
          "id": "TEST-002",
          "workorder_id": "WO-UNIFIED-MCP-HTTP-SERVER-001",
          "description": "Test /mcp tools/list returns unified tool list",
          "details": "Verify tools from all 4 servers appear in response"
        },
        {
          "id": "TEST-003",
          "workorder_id": "WO-UNIFIED-MCP-HTTP-SERVER-001",
          "description": "Test tool invocation works for each server's tools",
          "details": "Call sample tool from each server (docs, coderef, hello, personas)"
        },
        {
          "id": "TEST-004",
          "workorder_id": "WO-UNIFIED-MCP-HTTP-SERVER-001",
          "description": "Test graceful degradation if one server missing",
          "details": "Temporarily rename one server directory, verify others still work"
        },
        {
          "id": "TEST-005",
          "workorder_id": "WO-UNIFIED-MCP-HTTP-SERVER-001",
          "description": "Test /health shows status of all servers",
          "details": "Verify servers_loaded field shows true/false for each server"
        },
        {
          "id": "DEPLOY-001",
          "workorder_id": "WO-UNIFIED-MCP-HTTP-SERVER-001",
          "description": "Verify Railway deployment has access to all 4 server directories",
          "details": "Check Railway file structure includes docs-mcp, coderef-mcp, hello-world-mcp, personas-mcp"
        },
        {
          "id": "DEPLOY-002",
          "workorder_id": "WO-UNIFIED-MCP-HTTP-SERVER-001",
          "description": "Commit changes to http_server.py with descriptive message",
          "details": "Git commit message: Add unified multi-server support for all 4 MCP servers"
        },
        {
          "id": "DEPLOY-003",
          "workorder_id": "WO-UNIFIED-MCP-HTTP-SERVER-001",
          "description": "Push to Railway and verify deployment succeeds",
          "details": "Check Railway logs for successful server imports and tool counts"
        },
        {
          "id": "INTEGRATE-001",
          "workorder_id": "WO-UNIFIED-MCP-HTTP-SERVER-001",
          "description": "Test ChatGPT connector with unified endpoint",
          "details": "Verify ChatGPT can see and invoke tools from all 4 servers"
        },
        {
          "id": "DOC-001",
          "workorder_id": "WO-UNIFIED-MCP-HTTP-SERVER-001",
          "description": "Update CHATGPT-INTEGRATION-TROUBLESHOOTING.md with multi-server info",
          "details": "Document that all 4 servers are now exposed, include tool count breakdown"
        }
      ]
    },

    "6_implementation_phases": [
      {
        "phase": 1,
        "title": "Exploration & Verification",
        "purpose": "Verify all server directories exist and are importable",
        "complexity": "low",
        "effort_level": 1,
        "tasks": ["EXPLORE-001", "EXPLORE-002"],
        "completion_criteria": "All 4 server directories verified, test imports succeed"
      },
      {
        "phase": 2,
        "title": "Core Implementation",
        "purpose": "Build multi-server loading and routing infrastructure",
        "complexity": "medium",
        "effort_level": 3,
        "tasks": ["IMPL-001", "IMPL-002", "IMPL-003", "IMPL-004"],
        "completion_criteria": "Server loading and routing functions implemented and tested"
      },
      {
        "phase": 3,
        "title": "Endpoint Updates",
        "purpose": "Update all HTTP endpoints to use unified registry",
        "complexity": "medium",
        "effort_level": 2,
        "tasks": ["IMPL-005", "IMPL-006", "IMPL-007", "IMPL-008", "IMPL-009"],
        "completion_criteria": "All endpoints updated, server compiles and runs locally"
      },
      {
        "phase": 4,
        "title": "Testing & Validation",
        "purpose": "Verify all servers work correctly through unified endpoint",
        "complexity": "medium",
        "effort_level": 2,
        "tasks": ["TEST-001", "TEST-002", "TEST-003", "TEST-004", "TEST-005"],
        "completion_criteria": "All local tests pass, tools from all servers accessible"
      },
      {
        "phase": 5,
        "title": "Deployment & Integration",
        "purpose": "Deploy to Railway and verify ChatGPT integration",
        "complexity": "medium",
        "effort_level": 2,
        "tasks": ["DEPLOY-001", "DEPLOY-002", "DEPLOY-003", "INTEGRATE-001", "DOC-001"],
        "completion_criteria": "Railway deployment successful, ChatGPT can access all tools"
      }
    ],

    "7_testing_strategy": {
      "unit_tests": {
        "scope": "Helper functions in isolation",
        "coverage_target": "100% for loader and router functions",
        "tests": [
          "test_load_mcp_servers() with all servers present",
          "test_load_mcp_servers() with one server missing",
          "test_build_unified_tool_registry() with no duplicates",
          "test_build_unified_tool_registry() detects duplicate tool names",
          "test_route_tool_call() routes to correct server",
          "test_route_tool_call() handles unknown tool name"
        ]
      },
      "integration_tests": {
        "scope": "Full HTTP request flow through all servers",
        "focus": "End-to-end tool discovery and invocation",
        "tests": [
          "test_tools_endpoint_includes_all_servers",
          "test_tools_list_includes_all_servers",
          "test_invoke_docs_mcp_tool",
          "test_invoke_coderef_mcp_tool",
          "test_invoke_hello_world_mcp_tool",
          "test_invoke_personas_mcp_tool"
        ]
      },
      "edge_case_scenarios": [
        {
          "scenario": "One server directory missing",
          "setup": "Rename coderef-mcp directory temporarily",
          "expected_behavior": "Other 3 servers load successfully, error logged",
          "verification": "/health shows 3/4 servers loaded",
          "error_handling": "Graceful degradation - continue with available servers"
        },
        {
          "scenario": "Duplicate tool name across servers",
          "setup": "Two servers define 'list_templates' tool",
          "expected_behavior": "First occurrence used, warning logged",
          "verification": "Tool routes to first server, warning in logs",
          "error_handling": "Log collision, use first-wins policy"
        },
        {
          "scenario": "Server import fails (syntax error)",
          "setup": "Introduce syntax error in one server.py",
          "expected_behavior": "Import fails, error logged, other servers work",
          "verification": "/health shows 3/4 servers loaded",
          "error_handling": "Try/except on import, continue with others"
        }
      ]
    },

    "8_success_criteria": {
      "functional": [
        {
          "requirement": "All 4 servers load successfully",
          "metric": "Server import count",
          "target": "4/4 servers imported",
          "validation": "/health endpoint shows servers_loaded: {docs-mcp: true, coderef-mcp: true, hello-world-mcp: true, personas-mcp: true}"
        },
        {
          "requirement": "Unified tool list includes all servers",
          "metric": "Total tool count",
          "target": ">33 tools (docs-mcp already has 33)",
          "validation": "/tools endpoint returns methods array with >33 elements"
        },
        {
          "requirement": "Tool routing works correctly",
          "metric": "Tool invocation success rate",
          "target": "100% success for tools from all servers",
          "validation": "Invoke sample tool from each server via /mcp endpoint"
        },
        {
          "requirement": "ChatGPT can access all tools",
          "metric": "ChatGPT connector tool count",
          "target": "ChatGPT shows >33 tools available",
          "validation": "ChatGPT tool list shows tools from all 4 servers"
        }
      ],
      "quality": [
        {
          "requirement": "Graceful degradation",
          "metric": "Behavior when one server missing",
          "target": "Other servers still work",
          "validation": "Remove one server, verify others accessible"
        },
        {
          "requirement": "Error logging",
          "metric": "Import failures logged",
          "target": "All import errors logged with server name",
          "validation": "Check logs for import diagnostics"
        },
        {
          "requirement": "No breaking changes",
          "metric": "Existing docs-mcp tools work",
          "target": "All 33 docs-mcp tools still functional",
          "validation": "Regression test docs-mcp tools"
        }
      ],
      "performance": [
        {
          "requirement": "Startup time",
          "metric": "Server initialization duration",
          "target": "<2 seconds",
          "validation": "Measure time from import to Flask ready"
        },
        {
          "requirement": "Tool routing overhead",
          "metric": "P95 latency for tool calls",
          "target": "<10ms routing overhead",
          "validation": "Benchmark tool calls before/after routing"
        }
      ],
      "security": [
        {
          "requirement": "Import path security",
          "metric": "Only known directories imported",
          "target": "No user-controlled import paths",
          "validation": "Code review import logic"
        },
        {
          "requirement": "Tool namespace isolation",
          "metric": "Duplicate detection",
          "target": "All collisions logged",
          "validation": "Check logs for duplicate warnings"
        }
      ]
    },

    "9_implementation_checklist": {
      "pre": [
        "☐ Review existing http_server.py structure and imports",
        "☐ Verify all 4 MCP server directories exist",
        "☐ Test importing each server module individually"
      ],
      "phase_1": [
        "☐ EXPLORE-001: Verify server directories",
        "☐ EXPLORE-002: Test individual imports"
      ],
      "phase_2": [
        "☐ IMPL-001: Add SERVER_DIRS constant",
        "☐ IMPL-002: Create _load_mcp_servers()",
        "☐ IMPL-003: Create _build_unified_tool_registry()",
        "☐ IMPL-004: Create _route_tool_call()"
      ],
      "phase_3": [
        "☐ IMPL-005: Update /tools endpoint",
        "☐ IMPL-006: Update /mcp tools/list",
        "☐ IMPL-007: Update /mcp tool execution",
        "☐ IMPL-008: Update /health endpoint",
        "☐ IMPL-009: Update root / endpoint"
      ],
      "phase_4": [
        "☐ TEST-001: Test /tools returns all servers",
        "☐ TEST-002: Test /mcp tools/list unified",
        "☐ TEST-003: Test tool invocation per server",
        "☐ TEST-004: Test graceful degradation",
        "☐ TEST-005: Test /health server status"
      ],
      "phase_5": [
        "☐ DEPLOY-001: Verify Railway directory access",
        "☐ DEPLOY-002: Git commit",
        "☐ DEPLOY-003: Push to Railway",
        "☐ INTEGRATE-001: Test ChatGPT connector",
        "☐ DOC-001: Update troubleshooting guide"
      ],
      "final": [
        "☐ All tests pass locally",
        "☐ All 4 servers load successfully",
        "☐ Tool count >33 (all servers included)",
        "☐ ChatGPT can invoke tools from all servers",
        "☐ Railway deployment successful",
        "☐ Documentation updated",
        "☐ No regressions in docs-mcp tools"
      ]
    }
  }
}
