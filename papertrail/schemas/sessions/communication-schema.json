{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://coderef.dev/schemas/communication.json",
  "title": "Session Communication File",
  "description": "Agent roster and status tracking for multi-agent sessions in the CodeRef ecosystem. Supports 1-N agents (flexible agent count, not fixed roster). Optional phase tracking for multi-phase sessions.",
  "type": "object",
  "required": [
    "workorder_id",
    "feature_name",
    "created",
    "status",
    "description",
    "instructions_file",
    "orchestrator",
    "agents"
  ],
  "additionalProperties": false,

  "properties": {
    "workorder_id": {
      "type": "string",
      "pattern": "^WO-[A-Z0-9-]+-\\d{3}$",
      "description": "IMMUTABLE: Workorder identifier following pattern WO-{CATEGORY}-{ID} (e.g., WO-CORE-DASHBOARD-INTEGRATION-001)",
      "examples": [
        "WO-CORE-DASHBOARD-INTEGRATION-001",
        "WO-DOCUMENT-EFFECTIVENESS-001",
        "WO-CODEREF-IO-INVENTORY-001"
      ]
    },

    "feature_name": {
      "type": "string",
      "pattern": "^[a-z0-9-]+$",
      "minLength": 3,
      "maxLength": 100,
      "description": "IMMUTABLE: Session name in kebab-case matching the session directory name",
      "examples": [
        "coderef-core-dashboard-integration",
        "document-effectiveness",
        "ecosystem-resource-inventory"
      ]
    },

    "created": {
      "type": "string",
      "pattern": "^\\d{4}-\\d{2}-\\d{2}$",
      "description": "IMMUTABLE: Creation date in YYYY-MM-DD format",
      "examples": ["2026-01-04", "2026-01-02"]
    },

    "status": {
      "type": "string",
      "enum": ["not_started", "in_progress", "complete"],
      "description": "ORCHESTRATOR-OWNED: Overall session lifecycle state",
      "default": "not_started"
    },

    "description": {
      "type": "string",
      "minLength": 10,
      "maxLength": 500,
      "description": "Brief description of what agents will accomplish in this session"
    },

    "phases": {
      "type": "object",
      "description": "OPTIONAL: Phase-based progress tracking for multi-phase sessions. Each phase has status, progress, and lead agents.",
      "patternProperties": {
        "^phase_[1-9]$": {
          "type": "object",
          "required": ["status", "progress", "lead_agents"],
          "properties": {
            "status": {
              "type": "string",
              "enum": ["not_started", "in_progress", "complete"],
              "description": "Phase status"
            },
            "progress": {
              "type": "string",
              "description": "Human-readable progress (e.g., '1/11 tasks complete (9%)')"
            },
            "lead_agents": {
              "type": "array",
              "items": {"type": "string"},
              "description": "Agents leading this phase"
            },
            "gate_criteria": {
              "type": "array",
              "items": {"type": "string"},
              "description": "Optional criteria to advance to next phase"
            }
          }
        }
      },
      "additionalProperties": false
    },

    "instructions_file": {
      "type": "string",
      "pattern": "^C:\\\\.*\\\\instructions\\.json$",
      "description": "IMMUTABLE: Absolute Windows path to instructions.json file",
      "examples": [
        "C:\\Users\\willh\\.mcp-servers\\coderef\\sessions\\coderef-core-dashboard-integration\\instructions.json"
      ]
    },

    "orchestrator": {
      "type": "object",
      "required": ["agent_id", "agent_path", "role", "output_file", "status", "notes"],
      "additionalProperties": false,
      "properties": {
        "agent_id": {
          "type": "string",
          "const": "coderef",
          "description": "IMMUTABLE: Always 'coderef' for orchestrator agent"
        },

        "agent_path": {
          "type": "string",
          "const": "C:\\Users\\willh\\.mcp-servers\\coderef",
          "description": "IMMUTABLE: Absolute path to orchestrator project"
        },

        "role": {
          "type": "string",
          "minLength": 10,
          "maxLength": 200,
          "description": "What orchestrator does in this specific session (e.g., 'Synthesize agent plans into unified roadmap')"
        },

        "output_file": {
          "type": "string",
          "pattern": "^C:\\\\.*\\\\orchestrator-.*\\.(json|md|txt)$",
          "description": "IMMUTABLE: Absolute Windows path where orchestrator writes synthesis output",
          "examples": [
            "C:\\Users\\willh\\.mcp-servers\\coderef\\sessions\\coderef-core-dashboard-integration\\orchestrator-plan.json"
          ]
        },

        "status": {
          "type": "string",
          "enum": ["not_started", "in_progress", "complete"],
          "description": "ORCHESTRATOR-OWNED: Orchestrator's own status",
          "default": "not_started"
        },

        "notes": {
          "type": "string",
          "description": "Optional notes from orchestrator (e.g., blockers, decisions)"
        }
      }
    },

    "agents": {
      "type": "array",
      "minItems": 1,
      "maxItems": 20,
      "description": "Array of participating agents (order doesn't matter)",
      "items": {
        "type": "object",
        "required": ["agent_id", "agent_path", "output_file", "status", "notes"],
        "additionalProperties": false,
        "properties": {
          "agent_id": {
            "type": "string",
            "enum": [
              "coderef-assistant",
              "coderef-context",
              "coderef-workflow",
              "coderef-docs",
              "coderef-personas",
              "coderef-testing",
              "papertrail",
              "coderef-system",
              "coderef-dashboard",
              "coderef-packages",
              "coderef-core"
            ],
            "description": "IMMUTABLE: Valid agent identifier from CodeRef ecosystem. Flexible agent count (1-20 agents supported)."
          },

          "agent_path": {
            "type": "string",
            "pattern": "^C:\\\\",
            "description": "IMMUTABLE: Absolute Windows path to agent's project directory",
            "examples": [
              "C:\\Users\\willh\\Desktop\\assistant",
              "C:\\Users\\willh\\.mcp-servers\\coderef-context",
              "C:\\Users\\willh\\Desktop\\projects\\coderef-system\\packages"
            ]
          },

          "output_file": {
            "type": "string",
            "pattern": "^C:\\\\.*\\\\[a-z0-9-]+-.*\\.(json|md|txt)$",
            "description": "IMMUTABLE: Absolute Windows path where agent writes output (must start with agent_id)",
            "examples": [
              "C:\\Users\\willh\\.mcp-servers\\coderef\\sessions\\coderef-core-dashboard-integration\\coderef-packages-plan.json"
            ]
          },

          "status": {
            "type": "string",
            "enum": ["not_started", "in_progress", "complete"],
            "description": "AGENT-OWNED: Self-reported status (agents write, orchestrator reads)",
            "default": "not_started"
          },

          "notes": {
            "type": "string",
            "description": "Optional notes from agent (e.g., 'Blocked on packages agent', 'Found 3 resource sheets')"
          }
        }
      }
    },

    "aggregation": {
      "type": "object",
      "required": ["total_agents", "completed", "pending", "not_started"],
      "additionalProperties": false,
      "description": "OPTIONAL - ORCHESTRATOR-COMPUTED: Calculated by orchestrator when reading communication.json. Agents NEVER update this field to avoid file locking conflicts. Orchestrator computes counts dynamically from agents[].status array.",
      "properties": {
        "total_agents": {
          "type": "integer",
          "minimum": 1,
          "maximum": 20,
          "description": "Total number of agents (must equal length of agents[] array)"
        },

        "completed": {
          "type": "integer",
          "minimum": 0,
          "description": "Count of agents with status='complete'"
        },

        "pending": {
          "type": "integer",
          "minimum": 0,
          "description": "Count of agents with status='in_progress'"
        },

        "not_started": {
          "type": "integer",
          "minimum": 0,
          "description": "Count of agents with status='not_started'"
        }
      }
    }
  },

  "definitions": {
    "agent_status_enum": {
      "type": "string",
      "enum": ["not_started", "in_progress", "complete"],
      "description": "Valid status values - DO NOT use 'completed' (typo), 'done', 'finished', etc."
    }
  },

  "$comment": "STATE OWNERSHIP RULES: (1) Immutable fields (workorder_id, feature_name, paths) NEVER change after creation. (2) Orchestrator owns: session status, orchestrator.status, aggregation.* (computed). (3) Agents own: their own agents[].status and agents[].notes. (4) Orchestrator READS agent statuses but NEVER writes them. (5) Aggregation is OPTIONAL and COMPUTED - agents must NEVER update it to avoid file locking conflicts. (6) Orchestrator calculates aggregation dynamically from agents[].status when needed."
}
