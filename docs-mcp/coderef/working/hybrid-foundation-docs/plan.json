{
  "META_DOCUMENTATION": {
    "workorder_id": "WO-CODEREF-FOUNDATION-003",
    "feature_name": "hybrid-foundation-docs",
    "status": "planned",
    "created_at": "2025-12-15T00:00:00Z",
    "depends_on": ["WO-CODEREF-FOUNDATION-002"],
    "coderef_cli_path": "C:/Users/willh/Desktop/projects/coderef-system/packages/cli"
  },
  "1_executive_summary": {
    "goal": "Integrate coderef-system CLI with docs-mcp for 99% accurate, relationship-aware documentation generation",
    "background": [
      "WO-CODEREF-FOUNDATION-002 complete: Added API.md to coderef-foundation-docs",
      "Current overlap between /coderef-foundation-docs (auto) and /generate-docs (templates)",
      "coderef-system CLI provides AST-based scanning with 99% accuracy"
    ],
    "integration_decision": "Option B - Read .coderef/*.json files directly (no subprocess, instant, backward compatible)",
    "success_criteria": [
      "/coderef-foundation-docs generates 6 files with relationship data",
      "If .coderef/ exists: 99% accurate data + Mermaid diagrams + callers/callees",
      "If .coderef/ missing: Falls back to regex detection (backward compatible)",
      "COMPONENTS.md covers ALL modules: Handlers, Generators, Services, Utilities",
      "/generate-docs removed completely",
      "All tests pass"
    ]
  },
  "2_why_coderef_cli": {
    "comparison_table": {
      "headers": ["Feature", "Current (regex)", "With coderef CLI"],
      "rows": [
        ["Element accuracy", "85%", "99% (AST-based)"],
        ["Relationships", "None", "Full call graphs"],
        ["Type detection", "Basic", "26 type designators"],
        ["Impact analysis", "None", "coderef impact command"],
        ["Diagrams", "None", "Mermaid/GraphViz generation"]
      ]
    }
  },
  "3_integration_decision": {
    "chosen": "Option B - Read .coderef/ files",
    "comparison_table": {
      "headers": ["Factor", "Option A (Shell)", "Option B (Files)", "Option C (Port)"],
      "rows": [
        ["Accuracy", "99%", "99%", "85%"],
        ["Speed", "2-5s", "<100ms", "1-2s"],
        ["Dependencies", "Node/pnpm", "None", "None"],
        ["Maintenance", "Low", "Low", "High"]
      ]
    },
    "why_option_b": [
      "Same 99% accuracy as Option A (uses coderef's AST scanner)",
      "Instant generation (<100ms vs 2-5s subprocess)",
      "No runtime dependencies",
      "User controls when to re-scan",
      "Graceful fallback to regex"
    ],
    "user_workflow": [
      "cd my-project",
      "coderef index              # Run ONCE (or when code changes)",
      "/coderef-foundation-docs   # INSTANT - reads cached JSON"
    ]
  },
  "4_approach_steps": [
    {"step": 1, "action": "Run coderef scan --analyzer ast", "result": "Get precise element inventory"},
    {"step": 2, "action": "Run coderef index", "result": "Build relationship graph"},
    {"step": 3, "action": "Load POWER template", "result": "Get comprehensive structure"},
    {"step": 4, "action": "Auto-fill from .coderef/", "result": "Elements, relationships, metrics"},
    {"step": 5, "action": "Generate diagrams", "result": "Mermaid dependency diagrams"},
    {"step": 6, "action": "Mark gaps", "result": "<!-- AGENT: prompt --> for context"},
    {"step": 7, "action": "Agent enhances", "result": "Fill purpose, examples, rationale"}
  ],
  "5_target_output": {
    "structure": [
      "README.md (project root)",
      "coderef/foundation-docs/ARCHITECTURE.md",
      "coderef/foundation-docs/SCHEMA.md",
      "coderef/foundation-docs/COMPONENTS.md (ALL modules, not just UI)",
      "coderef/foundation-docs/API.md",
      "coderef/foundation-docs/project-context.json"
    ],
    "file_details": {
      "README.md": "Project root - stats, architecture diagram, quick start",
      "ARCHITECTURE.md": "Dependency graph, metrics, high-impact elements",
      "SCHEMA.md": "Entity relationships, database tables",
      "COMPONENTS.md": "ALL modules with call relationships",
      "API.md": "Endpoint dependency chains",
      "project-context.json": "Machine-readable context for planning"
    }
  },
  "6_coderef_data_structures": {
    "index_json": {
      "location": ".coderef/index.json",
      "format": "Array of ElementData",
      "example": {
        "type": "function",
        "name": "handle_create_plan",
        "file": "tool_handlers.py",
        "line": 245,
        "calls": ["PlanGenerator.generate", "validate_inputs"]
      }
    },
    "graph_json": {
      "location": ".coderef/graph.json",
      "format": "Nodes + Edges + Metadata",
      "example": {
        "nodes": [["nodeId", {"id": "...", "type": "function", "file": "..."}]],
        "edges": [["edgeId", {"source": "...", "target": "...", "type": "calls"}]],
        "metadata": {"nodeCount": 142, "edgeCount": 250}
      },
      "edge_types": ["imports", "calls", "depends-on", "implements", "extends", "tests"]
    }
  },
  "7_code_snippets": {
    "load_coderef_data": {
      "file": "generators/coderef_foundation_generator.py",
      "code": "def _load_coderef_data(self) -> Optional[dict]:\n    \"\"\"Load .coderef/index.json and graph.json if available.\"\"\"\n    index_path = self.project_path / '.coderef' / 'index.json'\n    graph_path = self.project_path / '.coderef' / 'graph.json'\n\n    if not index_path.exists():\n        return None  # Fall back to regex detection\n\n    return {\n        'elements': json.loads(index_path.read_text()),\n        'graph': json.loads(graph_path.read_text()) if graph_path.exists() else None\n    }"
    },
    "mermaid_formatter": {
      "file": "generators/mermaid_formatter.py",
      "functions": [
        "def generate_module_diagram(graph: dict, max_depth: int = 2) -> str:",
        "def generate_element_diagram(graph: dict, element_id: str) -> str:",
        "def compute_graph_metrics(graph: dict) -> dict:"
      ]
    }
  },
  "8_output_examples": {
    "components_md": {
      "summary": "# Project Components\n\n## Summary\n- **Total Elements:** 142 (from coderef scan)\n- **Functions:** 87 | **Classes:** 23 | **Components:** 32",
      "diagram": "## Dependency Diagram\n```mermaid\ngraph LR\n    server --> tool_handlers\n    tool_handlers --> generators\n    generators --> templates\n```",
      "handler_example": "## Handlers (12 detected)\n\n### handle_create_plan\n- **File:** `tool_handlers.py:245`\n- **Type:** async function\n- **Calls:** `PlanGenerator.generate()`, `validate_inputs()`\n- **Called by:** MCP dispatch (server.py:89)\n- **Purpose:** <!-- AGENT: Describe purpose -->",
      "generator_example": "## Generators (6 detected)\n\n### ChangelogGenerator\n- **File:** `generators/changelog_generator.py:15`\n- **Methods:** `add_change()`, `get_entries()`, `validate()`\n- **Used by:** `handle_add_changelog_entry`, `handle_update_changelog`\n- **Purpose:** <!-- AGENT: Describe purpose -->"
    },
    "architecture_md": {
      "diagram": "## Module Dependency Graph\n\n```mermaid\ngraph TB\n    subgraph \"Entry Points\"\n        server[server.py]\n    end\n    subgraph \"Handlers\"\n        handlers[tool_handlers.py]\n    end\n    subgraph \"Generators\"\n        gen1[changelog_generator.py]\n        gen2[foundation_generator.py]\n    end\n\n    server --> handlers\n    handlers --> gen1\n    handlers --> gen2\n```",
      "metrics": "## Metrics\n- **Total Files:** 24\n- **Total Elements:** 142\n- **Graph Density:** 0.12 (sparse, good modularity)\n- **Circular Dependencies:** 0 ✅\n- **Isolated Nodes:** 3 (constants, types)",
      "high_impact": "## High-Impact Elements\n| Element | Dependents | Risk |\n|---------|------------|------|\n| ErrorResponse | 21 | HIGH |\n| validate_path | 18 | HIGH |\n| logger | 15 | MEDIUM |"
    },
    "readme_md": "# {project_name}\n\n## Overview\n<!-- AGENT: Describe what this project does -->\n\n## Quick Stats\n| Metric | Value |\n|--------|-------|\n| Functions | 87 |\n| Classes | 23 |\n| API Endpoints | 32 |\n| Test Coverage | 85% |\n\n## Architecture Overview\n```mermaid\n{top_level_diagram}\n```\n\n## Quick Start\n<!-- AGENT: Installation and usage instructions -->\n\n## Documentation\n- [API Reference](coderef/foundation-docs/API.md)\n- [Architecture](coderef/foundation-docs/ARCHITECTURE.md)\n- [Components](coderef/foundation-docs/COMPONENTS.md)"
  },
  "8b_data_source_mapping": {
    "components_md": [
      {"section": "Summary", "source": "index.json element count by type"},
      {"section": "Diagram", "source": "graph.json → Mermaid via formatter"},
      {"section": "Handlers", "source": "index.json where name matches handle_*"},
      {"section": "Generators", "source": "index.json where name matches *Generator"},
      {"section": "Relationships", "source": "graph.json edges by source/target"}
    ],
    "architecture_md": [
      {"section": "Diagram", "source": "coderef diagram ./src --format mermaid"},
      {"section": "Metrics", "source": "graph.json → compute density, circularity"},
      {"section": "Impact", "source": "coderef impact for each high-degree node"}
    ]
  },
  "8c_element_detection_fallback": {
    "headers": ["Element Type", "coderef source", "Regex fallback"],
    "rows": [
      ["Functions", "index.json type=function", "def , function "],
      ["Classes", "index.json type=class", "class "],
      ["Components", "index.json type=component", "PascalCase + JSX"],
      ["Handlers", "name matches handle_*", "def handle_*"],
      ["Generators", "name matches *Generator", "class *Generator"],
      ["Services", "name matches *Service", "class *Service"],
      ["Relationships", "graph.json edges", "Not available"],
      ["Diagrams", "Generated from graph", "Not available"]
    ]
  },
  "8d_agent_markers": {
    "format": "<!-- AGENT: {prompt} -->",
    "standard_prompts": [
      "<!-- AGENT: Describe what this does and why -->",
      "<!-- AGENT: Add usage example -->",
      "<!-- AGENT: Explain design decision -->",
      "<!-- AGENT: When to use this vs alternatives -->"
    ]
  },
  "9_implementation_checklist": {
    "phases": [
      {
        "id": "phase_0",
        "name": "CLI Integration Layer",
        "tasks": [
          {
            "id": "IMPL-000",
            "description": "Create _load_coderef_data() method to read .coderef/index.json and graph.json",
            "file": "generators/coderef_foundation_generator.py",
            "status": "pending",
            "code_hint": "Returns None if .coderef/ missing (triggers regex fallback)"
          }
        ]
      },
      {
        "id": "phase_1",
        "name": "Refactor Generator to Use coderef Data",
        "tasks": [
          {
            "id": "IMPL-001",
            "description": "Add coderef data loading with regex fallback logic",
            "file": "generators/coderef_foundation_generator.py",
            "status": "pending"
          },
          {
            "id": "IMPL-002",
            "description": "Create element categorization (handlers, generators, services from index.json)",
            "file": "generators/coderef_foundation_generator.py",
            "status": "pending",
            "patterns": {
              "handlers": "name.startswith('handle_')",
              "generators": "name.endswith('Generator')",
              "services": "name.endswith('Service')"
            }
          }
        ]
      },
      {
        "id": "phase_2",
        "name": "Enhanced COMPONENTS.md with Relationships",
        "tasks": [
          {
            "id": "IMPL-003",
            "description": "Refactor _generate_components_md() to use coderef elements",
            "file": "generators/coderef_foundation_generator.py",
            "status": "pending"
          },
          {
            "id": "IMPL-004",
            "description": "Add callers/callees extraction from graph.json edges",
            "file": "generators/coderef_foundation_generator.py",
            "status": "pending",
            "note": "Use edgesBySource and edgesByTarget for O(1) lookups"
          },
          {
            "id": "IMPL-005",
            "description": "Add sections: Handlers, Generators, Services, Middleware, Utilities",
            "file": "generators/coderef_foundation_generator.py",
            "status": "pending"
          }
        ]
      },
      {
        "id": "phase_3",
        "name": "Enhanced ARCHITECTURE.md with Diagrams",
        "tasks": [
          {
            "id": "IMPL-006",
            "description": "Create mermaid_formatter.py with generate_module_diagram()",
            "file": "generators/mermaid_formatter.py",
            "status": "pending",
            "new_file": true
          },
          {
            "id": "IMPL-007",
            "description": "Add compute_graph_metrics() for density, circularity",
            "file": "generators/mermaid_formatter.py",
            "status": "pending",
            "metrics": ["nodeCount", "edgeCount", "density", "circularDependencies", "isolatedNodes"]
          },
          {
            "id": "IMPL-008",
            "description": "Update _generate_architecture_md() to include diagrams and metrics",
            "file": "generators/coderef_foundation_generator.py",
            "status": "pending"
          },
          {
            "id": "IMPL-009",
            "description": "Add high-impact elements section (elements with most dependents)",
            "file": "generators/coderef_foundation_generator.py",
            "status": "pending",
            "note": "Sort by edge count descending, show top 10"
          }
        ]
      },
      {
        "id": "phase_4",
        "name": "Add README.md Generation",
        "tasks": [
          {
            "id": "IMPL-010",
            "description": "Add _generate_readme_md() method with stats and diagram",
            "file": "generators/coderef_foundation_generator.py",
            "status": "pending"
          },
          {
            "id": "IMPL-011",
            "description": "Update generate() to write README.md to project root",
            "file": "generators/coderef_foundation_generator.py",
            "status": "pending",
            "note": "README.md goes to project root, not coderef/foundation-docs/"
          }
        ]
      },
      {
        "id": "phase_5",
        "name": "Update Slash Command Workflow",
        "tasks": [
          {
            "id": "DOC-001",
            "description": "Update coderef-foundation-docs.md with coderef integration workflow",
            "file": ".claude/commands/coderef-foundation-docs.md",
            "status": "pending"
          }
        ]
      },
      {
        "id": "phase_6",
        "name": "Remove /generate-docs",
        "tasks": [
          {
            "id": "REMOVE-001",
            "description": "Delete generate-docs.md slash command",
            "file": ".claude/commands/generate-docs.md",
            "status": "pending",
            "action": "DELETE"
          },
          {
            "id": "REMOVE-002",
            "description": "Remove handle_generate_foundation_docs from tool_handlers.py",
            "file": "tool_handlers.py",
            "status": "pending"
          },
          {
            "id": "REMOVE-003",
            "description": "Remove generate_foundation_docs tool from server.py",
            "file": "server.py",
            "status": "pending"
          },
          {
            "id": "REMOVE-004",
            "description": "Update CLAUDE.md to remove /generate-docs references",
            "file": "CLAUDE.md",
            "status": "pending"
          },
          {
            "id": "REMOVE-005",
            "description": "Update TOOLS-REFERENCE.md to remove generate-docs tool",
            "file": "../../TOOLS-REFERENCE.md",
            "status": "pending"
          }
        ]
      },
      {
        "id": "phase_7",
        "name": "Testing",
        "tasks": [
          {
            "id": "TEST-001",
            "description": "Add unit tests for _load_coderef_data() - handles missing .coderef/",
            "file": "tests/unit/generators/test_coderef_foundation_generator.py",
            "status": "pending"
          },
          {
            "id": "TEST-002",
            "description": "Add unit tests for mermaid diagram generation",
            "file": "tests/unit/generators/test_mermaid_formatter.py",
            "status": "pending",
            "new_file": true
          },
          {
            "id": "TEST-003",
            "description": "Add unit tests for element categorization (handlers, generators, etc.)",
            "file": "tests/unit/generators/test_coderef_foundation_generator.py",
            "status": "pending"
          },
          {
            "id": "TEST-004",
            "description": "Add integration test with real coderef output on docs-mcp",
            "file": "tests/integration/test_coderef_foundation_docs.py",
            "status": "pending"
          },
          {
            "id": "TEST-005",
            "description": "Run full test suite and verify all pass",
            "status": "pending"
          }
        ]
      }
    ]
  },
  "10_key_files": {
    "to_modify": [
      {"file": "generators/coderef_foundation_generator.py", "changes": ["_load_coderef_data()", "_generate_components_md()", "_generate_architecture_md()", "_generate_readme_md()"]},
      {"file": ".claude/commands/coderef-foundation-docs.md", "changes": ["Update workflow with coderef integration"]},
      {"file": "tool_handlers.py", "changes": ["Remove handle_generate_foundation_docs"]},
      {"file": "server.py", "changes": ["Remove generate_foundation_docs tool"]},
      {"file": "CLAUDE.md", "changes": ["Remove /generate-docs references"]},
      {"file": "../../TOOLS-REFERENCE.md", "changes": ["Remove generate-docs tool"]}
    ],
    "to_create": [
      {"file": "generators/mermaid_formatter.py", "purpose": "Mermaid diagram generation from graph.json"},
      {"file": "tests/unit/generators/test_mermaid_formatter.py", "purpose": "Unit tests for mermaid formatter"}
    ],
    "to_delete": [
      ".claude/commands/generate-docs.md"
    ]
  },
  "11_testing_strategy": {
    "unit_tests": [
      "test_load_coderef_data() - handles missing .coderef/",
      "test_load_coderef_data_with_index() - loads valid index.json",
      "test_mermaid_generation() - valid Mermaid syntax",
      "test_element_categorization() - handlers, generators, services",
      "test_graph_metrics() - density, circularity calculation",
      "test_fallback_to_regex() - when .coderef/ missing"
    ],
    "integration_tests": [
      "Test with real coderef-system output on docs-mcp itself",
      "Verify backward compatibility without .coderef/",
      "Test diagram rendering (Mermaid syntax validation)"
    ]
  },
  "12_success_criteria_detailed": {
    "with_coderef": [
      "Use 99% accurate AST data from index.json",
      "Include Mermaid dependency diagrams in ARCHITECTURE.md",
      "Show callers/callees for each element in COMPONENTS.md",
      "Display graph metrics (density, circularity, isolated nodes)",
      "Show high-impact elements with risk assessment"
    ],
    "without_coderef": [
      "Fall back to regex detection (backward compatible)",
      "Skip diagram generation",
      "Skip relationship data",
      "Still generate all 6 files with basic content"
    ],
    "components_md_sections": [
      "UI Components",
      "Handlers",
      "Generators",
      "Services",
      "Middleware",
      "Utilities"
    ]
  }
}
