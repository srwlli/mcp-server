{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "plan.schema.json",
  "title": "Implementation Plan Schema",
  "description": "Schema for plan.json files - single source of truth for all planning tools",
  "version": "1.1.0",
  "type": "object",
  "required": ["META_DOCUMENTATION", "UNIVERSAL_PLANNING_STRUCTURE"],
  "properties": {
    "META_DOCUMENTATION": {
      "type": "object",
      "required": ["feature_name", "schema_version", "status"],
      "properties": {
        "feature_name": {
          "type": "string",
          "pattern": "^[a-zA-Z0-9_-]+$",
          "description": "Feature name (alphanumeric, hyphens, underscores)"
        },
        "project": {
          "type": "string",
          "description": "Project this feature belongs to (e.g., 'scriptboard', 'scrapper', 'gridiron-franchise')"
        },
        "schema_version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$",
          "description": "Schema version this plan conforms to",
          "default": "1.0.0"
        },
        "version": {
          "type": "string",
          "description": "Plan document version"
        },
        "status": {
          "type": "string",
          "enum": ["draft", "complete", "approved", "archived"]
        },
        "generated_by": {
          "type": "string"
        },
        "generated_at": {
          "type": "string",
          "format": "date"
        }
      }
    },
    "UNIVERSAL_PLANNING_STRUCTURE": {
      "type": "object",
      "required": [
        "0_preparation",
        "1_executive_summary",
        "2_risk_assessment",
        "3_current_state_analysis",
        "4_key_features",
        "5_task_id_system",
        "6_implementation_phases",
        "7_testing_strategy",
        "8_success_criteria",
        "9_implementation_checklist"
      ],
      "properties": {
        "0_preparation": {
          "$ref": "#/$defs/preparation"
        },
        "1_executive_summary": {
          "$ref": "#/$defs/executive_summary"
        },
        "2_risk_assessment": {
          "$ref": "#/$defs/risk_assessment"
        },
        "3_current_state_analysis": {
          "$ref": "#/$defs/current_state_analysis"
        },
        "4_key_features": {
          "$ref": "#/$defs/key_features"
        },
        "5_task_id_system": {
          "$ref": "#/$defs/task_id_system"
        },
        "6_implementation_phases": {
          "$ref": "#/$defs/implementation_phases"
        },
        "7_testing_strategy": {
          "$ref": "#/$defs/testing_strategy"
        },
        "8_success_criteria": {
          "$ref": "#/$defs/success_criteria"
        },
        "9_implementation_checklist": {
          "$ref": "#/$defs/implementation_checklist"
        }
      }
    }
  },
  "$defs": {
    "preparation": {
      "type": "object",
      "properties": {
        "project_type": {
          "type": "string",
          "enum": ["greenfield", "enhancement", "refactor", "bugfix"]
        },
        "tech_stack": {
          "type": "object",
          "additionalProperties": { "type": "string" }
        },
        "key_dependencies": {
          "type": "array",
          "items": { "type": "string" }
        },
        "project_structure": {
          "type": "object",
          "additionalProperties": { "type": "string" }
        }
      }
    },
    "executive_summary": {
      "type": "object",
      "required": ["feature_name", "description", "goal"],
      "properties": {
        "feature_name": { "type": "string" },
        "description": { "type": "string" },
        "goal": { "type": "string" },
        "estimated_complexity": {
          "type": "string",
          "enum": ["low", "medium", "high", "critical"]
        },
        "estimated_tasks": { "type": "integer" },
        "key_deliverables": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "risk_assessment": {
      "type": "object",
      "properties": {
        "technical_risks": {
          "type": "array",
          "items": { "$ref": "#/$defs/risk_item" }
        },
        "scope_risks": {
          "type": "array",
          "items": { "$ref": "#/$defs/risk_item" }
        },
        "dependency_risks": {
          "type": "array",
          "items": { "$ref": "#/$defs/risk_item" }
        }
      }
    },
    "risk_item": {
      "type": "object",
      "required": ["risk", "severity", "mitigation"],
      "properties": {
        "risk": { "type": "string" },
        "severity": {
          "type": "string",
          "enum": ["low", "medium", "high", "critical"]
        },
        "mitigation": { "type": "string" }
      }
    },
    "current_state_analysis": {
      "type": "object",
      "properties": {
        "existing_files": {
          "type": "array",
          "items": { "type": "string" }
        },
        "files_to_create": {
          "type": "array",
          "items": { "$ref": "#/$defs/file_entry" }
        },
        "files_to_modify": {
          "type": "array",
          "items": { "$ref": "#/$defs/file_modification" }
        },
        "dependencies_to_add": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "file_entry": {
      "type": "object",
      "required": ["path", "purpose"],
      "properties": {
        "path": { "type": "string" },
        "purpose": { "type": "string" }
      }
    },
    "file_modification": {
      "type": "object",
      "required": ["path", "changes"],
      "properties": {
        "path": { "type": "string" },
        "changes": { "type": "string" }
      }
    },
    "key_features": {
      "type": "object",
      "required": ["features"],
      "properties": {
        "features": {
          "type": "array",
          "items": { "$ref": "#/$defs/feature_item" }
        }
      }
    },
    "feature_item": {
      "type": "object",
      "required": ["id", "name", "description", "priority", "tasks"],
      "properties": {
        "id": { "type": "string", "pattern": "^F\\d+$" },
        "name": { "type": "string" },
        "description": { "type": "string" },
        "priority": {
          "type": "string",
          "enum": ["critical", "high", "medium", "low"]
        },
        "tasks": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "task_id_system": {
      "type": "object",
      "required": ["workorder", "tasks"],
      "properties": {
        "workorder": {
          "type": "object",
          "required": ["id", "name", "feature_dir"],
          "properties": {
            "id": { "type": "string", "pattern": "^WO-[A-Z0-9-]+-\\d{3}$" },
            "name": { "type": "string" },
            "feature_dir": { "type": "string" }
          }
        },
        "tasks": {
          "type": "array",
          "items": { "$ref": "#/$defs/task_item" }
        }
      }
    },
    "task_item": {
      "type": "object",
      "required": ["id", "workorder_id", "description", "type", "files"],
      "properties": {
        "id": { "type": "string" },
        "workorder_id": { "type": "string" },
        "description": { "type": "string" },
        "type": {
          "type": "string",
          "enum": ["setup", "feature", "component", "test", "docs", "refactor"]
        },
        "files": {
          "type": "array",
          "items": { "type": "string" }
        },
        "estimated_loc": { "type": "integer" },
        "dependencies": {
          "type": "array",
          "items": { "type": "string" }
        },
        "verify_step": {
          "type": "string",
          "description": "How to verify task completion (e.g., 'Run pytest tests/test_auth.py', 'Check file exists', 'Verify endpoint returns 200')"
        },
        "status": {
          "type": "string",
          "enum": ["pending", "in_progress", "completed", "blocked"],
          "default": "pending"
        },
        "updated_at": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp of last status update"
        },
        "notes": {
          "type": "string",
          "description": "Optional notes about status change or blockers"
        }
      }
    },
    "implementation_phases": {
      "type": "object",
      "required": ["phases"],
      "properties": {
        "phases": {
          "type": "array",
          "items": { "$ref": "#/$defs/phase_item" }
        }
      }
    },
    "phase_item": {
      "type": "object",
      "required": ["phase", "name", "description", "tasks", "deliverables"],
      "properties": {
        "phase": { "type": "integer", "minimum": 1 },
        "name": { "type": "string" },
        "description": { "type": "string" },
        "tasks": {
          "type": "array",
          "items": { "type": "string" }
        },
        "deliverables": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "testing_strategy": {
      "type": "object",
      "properties": {
        "unit_tests": {
          "type": "array",
          "items": { "$ref": "#/$defs/test_target" }
        },
        "integration_tests": {
          "type": "array",
          "items": { "$ref": "#/$defs/test_target" }
        },
        "e2e_tests": {
          "type": "array",
          "items": { "$ref": "#/$defs/e2e_test" }
        },
        "manual_testing": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "test_target": {
      "type": "object",
      "required": ["target", "tests"],
      "properties": {
        "target": { "type": "string" },
        "tests": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "e2e_test": {
      "type": "object",
      "required": ["flow", "steps"],
      "properties": {
        "flow": { "type": "string" },
        "steps": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "success_criteria": {
      "type": "object",
      "properties": {
        "functional": {
          "type": "array",
          "items": { "type": "string" }
        },
        "performance": {
          "type": "array",
          "items": { "type": "string" }
        },
        "quality": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "implementation_checklist": {
      "type": "object",
      "additionalProperties": {
        "type": "array",
        "items": { "type": "string" }
      },
      "description": "Keys are phase names (e.g., 'phase_1_schema'), values are task arrays"
    }
  }
}
