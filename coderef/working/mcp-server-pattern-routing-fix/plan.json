{
  "META_DOCUMENTATION": {
    "feature_name": "mcp-server-pattern-routing-fix",
    "version": "1.0.0",
    "status": "complete",
    "generated_by": "Claude Code",
    "generated_at": "2025-12-03T07:00:00Z",
    "has_context": false,
    "has_analysis": false
  },
  "UNIVERSAL_PLANNING_STRUCTURE": {
    "0_preparation": {
      "foundation_docs": {
        "available": ["railway/README.md", "railway/USAGE-GUIDE.md", "docs-mcp/CLAUDE.md"],
        "missing": []
      },
      "coding_standards": {
        "available": [],
        "patterns_identified": [
          "TOOL_HANDLERS dict pattern for direct handler mapping",
          "MCP Server @app decorator pattern for request handling",
          "Flask request/response pattern with JSON"
        ]
      },
      "technology_stack": {
        "language": "Python 3.11+",
        "framework": "Flask",
        "libraries": ["mcp", "pydantic", "requests"],
        "deployment": "Railway"
      },
      "key_files": {
        "primary": "docs-mcp/http_server.py",
        "test": "railway/test/test_railway_mcp.py"
      }
    },
    "1_executive_summary": {
      "feature_description": "Fix request format normalization in the unified MCP gateway to properly route tool calls to MCP Server pattern servers (personas-mcp, coderef-mcp)",
      "primary_goal": "Enable all 54 tools to be callable through the unified /mcp endpoint with consistent request format",
      "problem_statement": "The gateway receives requests in {'method': 'tool_name', 'params': {}} format but MCP Server pattern tools expect {'name': 'tool_name', 'arguments': {}} format, causing validation errors",
      "solution_approach": "Add request normalization layer in http_server.py that converts params to arguments before routing to MCP Server pattern handlers",
      "estimated_complexity": "Low",
      "estimated_tasks": 5
    },
    "2_risk_assessment": {
      "overall_risk": "Low",
      "risks": [
        {
          "id": "RISK-001",
          "description": "Breaking existing docs-mcp tool calls",
          "likelihood": "Low",
          "impact": "High",
          "mitigation": "Maintain backward compatibility - accept both params and arguments"
        },
        {
          "id": "RISK-002",
          "description": "Async handling differences between patterns",
          "likelihood": "Medium",
          "impact": "Medium",
          "mitigation": "Use asyncio.run() wrapper consistently"
        }
      ]
    },
    "3_current_state_analysis": {
      "files_to_modify": [
        {
          "path": "docs-mcp/http_server.py",
          "changes": "Add request normalization in /mcp endpoint and _route_tool_call()",
          "lines_estimated": 20
        }
      ],
      "files_to_create": [],
      "files_to_test": [
        {
          "path": "railway/test/test_railway_mcp.py",
          "changes": "Update test_mcp_list_personas to verify fix"
        }
      ]
    },
    "4_key_features": {
      "features": [
        {
          "id": "FEAT-001",
          "name": "Request Format Normalization",
          "description": "Normalize incoming requests to support both 'params' and 'arguments' keys",
          "priority": "High"
        },
        {
          "id": "FEAT-002",
          "name": "Method/Name Normalization",
          "description": "Accept both 'method' and 'name' keys for tool identification",
          "priority": "High"
        },
        {
          "id": "FEAT-003",
          "name": "Backward Compatibility",
          "description": "Ensure existing docs-mcp calls continue to work unchanged",
          "priority": "Critical"
        }
      ]
    },
    "5_task_id_system": {
      "workorder": {
        "id": "WO-MCP-SERVER-PATTERN-ROUTING-FIX-001",
        "name": "MCP Server Pattern Routing Fix",
        "feature_dir": "coderef/working/mcp-server-pattern-routing-fix"
      },
      "tasks": [
        {
          "id": "NORM-001",
          "workorder_id": "WO-MCP-SERVER-PATTERN-ROUTING-FIX-001",
          "description": "Add normalize_mcp_request() function to convert request formats",
          "file": "docs-mcp/http_server.py",
          "type": "implementation",
          "priority": "High",
          "estimated_loc": 15
        },
        {
          "id": "NORM-002",
          "workorder_id": "WO-MCP-SERVER-PATTERN-ROUTING-FIX-001",
          "description": "Update /mcp endpoint to call normalize_mcp_request() before routing",
          "file": "docs-mcp/http_server.py",
          "type": "implementation",
          "priority": "High",
          "estimated_loc": 5
        },
        {
          "id": "ROUTE-001",
          "workorder_id": "WO-MCP-SERVER-PATTERN-ROUTING-FIX-001",
          "description": "Update _route_tool_call() to use normalized arguments",
          "file": "docs-mcp/http_server.py",
          "type": "refactor",
          "priority": "High",
          "estimated_loc": 10
        },
        {
          "id": "TEST-001",
          "workorder_id": "WO-MCP-SERVER-PATTERN-ROUTING-FIX-001",
          "description": "Update test_mcp_list_personas to verify fix works",
          "file": "railway/test/test_railway_mcp.py",
          "type": "test",
          "priority": "Medium",
          "estimated_loc": 5
        },
        {
          "id": "TEST-002",
          "workorder_id": "WO-MCP-SERVER-PATTERN-ROUTING-FIX-001",
          "description": "Run full test suite and verify all 14 tests pass",
          "file": "railway/test/test_railway_mcp.py",
          "type": "verification",
          "priority": "High",
          "estimated_loc": 0
        }
      ]
    },
    "6_implementation_phases": {
      "phases": [
        {
          "id": "PHASE-1",
          "name": "Request Normalization",
          "description": "Add request format normalization function",
          "tasks": ["NORM-001", "NORM-002"],
          "dependencies": [],
          "estimated_duration": "30 minutes"
        },
        {
          "id": "PHASE-2",
          "name": "Routing Update",
          "description": "Update routing to use normalized format",
          "tasks": ["ROUTE-001"],
          "dependencies": ["PHASE-1"],
          "estimated_duration": "15 minutes"
        },
        {
          "id": "PHASE-3",
          "name": "Testing & Verification",
          "description": "Update tests and verify all pass",
          "tasks": ["TEST-001", "TEST-002"],
          "dependencies": ["PHASE-2"],
          "estimated_duration": "15 minutes"
        }
      ]
    },
    "7_testing_strategy": {
      "unit_tests": [
        {
          "id": "UT-001",
          "description": "Test normalize_mcp_request() with params format",
          "input": {"method": "list_templates", "params": {}},
          "expected": {"name": "list_templates", "arguments": {}}
        },
        {
          "id": "UT-002",
          "description": "Test normalize_mcp_request() with arguments format",
          "input": {"name": "list_personas", "arguments": {}},
          "expected": {"name": "list_personas", "arguments": {}}
        }
      ],
      "integration_tests": [
        {
          "id": "IT-001",
          "description": "Test docs-mcp tool via /mcp endpoint",
          "tool": "list_templates"
        },
        {
          "id": "IT-002",
          "description": "Test personas-mcp tool via /mcp endpoint",
          "tool": "list_personas"
        },
        {
          "id": "IT-003",
          "description": "Test coderef-mcp tool via /mcp endpoint",
          "tool": "mcp__coderef__query"
        }
      ],
      "e2e_tests": [
        {
          "id": "E2E-001",
          "description": "Run full test_railway_mcp.py suite",
          "expected_result": "14/14 tests pass"
        }
      ]
    },
    "8_success_criteria": {
      "criteria": [
        {
          "id": "SC-001",
          "description": "All 54 tools callable via /mcp endpoint",
          "measurement": "Tool count from /health equals callable tools",
          "target": "54 tools"
        },
        {
          "id": "SC-002",
          "description": "Test suite passes completely",
          "measurement": "test_railway_mcp.py results",
          "target": "14/14 tests pass"
        },
        {
          "id": "SC-003",
          "description": "Backward compatibility maintained",
          "measurement": "Existing docs-mcp calls work unchanged",
          "target": "No breaking changes"
        },
        {
          "id": "SC-004",
          "description": "personas-mcp tools work via /mcp",
          "measurement": "list_personas returns valid response",
          "target": "200 OK with persona list"
        }
      ]
    },
    "9_implementation_checklist": {
      "phase_1": {
        "name": "Request Normalization",
        "tasks": [
          {
            "id": "NORM-001",
            "description": "Add normalize_mcp_request() function",
            "status": "pending",
            "checkbox": "[ ]"
          },
          {
            "id": "NORM-002",
            "description": "Update /mcp endpoint to normalize requests",
            "status": "pending",
            "checkbox": "[ ]"
          }
        ]
      },
      "phase_2": {
        "name": "Routing Update",
        "tasks": [
          {
            "id": "ROUTE-001",
            "description": "Update _route_tool_call() for normalized format",
            "status": "pending",
            "checkbox": "[ ]"
          }
        ]
      },
      "phase_3": {
        "name": "Testing & Verification",
        "tasks": [
          {
            "id": "TEST-001",
            "description": "Update test_mcp_list_personas test",
            "status": "pending",
            "checkbox": "[ ]"
          },
          {
            "id": "TEST-002",
            "description": "Run full test suite - all 14 pass",
            "status": "pending",
            "checkbox": "[ ]"
          }
        ]
      }
    }
  }
}
