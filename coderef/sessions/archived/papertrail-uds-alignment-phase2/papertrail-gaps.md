# Papertrail Gap Analysis - Phase 2

**Agent:** papertrail
**Date:** 2026-01-10
**Phase:** Phase 2 - Gap Analysis
**Workorder:** WO-PAPERTRAIL-UDS-ALIGNMENT-002

---

## Executive Summary

Papertrail gap analysis identifies **5 gaps** requiring attention to support 100% validation coverage across the CodeRef ecosystem. Primary gaps are **missing schemas** for workflow-specific JSON files generated by coderef-workflow.

**Key Findings:**
- **2 new schemas needed:** analysis.json (P2), execution-log.json (P1)
- **1 schema to skip:** risk-assessment.json (redundant - use plan.json instead)
- **ValidatorFactory updates:** Add 2 new path patterns
- **Total effort:** 14 hours across 5 gaps

**Impact:** These schemas enable coderef-workflow to validate 3+ critical workflow artifacts (analysis, execution logs), increasing overall validation rate by supporting Phase 3 integrations.

---

## Summary

| Metric | Count |
|--------|-------|
| **Total Gaps** | 5 |
| **P0 (Critical)** | 0 |
| **P1 (High)** | 1 |
| **P2 (Medium)** | 3 |
| **P3 (Low)** | 1 |
| **Total Effort** | 14 hours |
| **Estimated Timeline** | 1-2 weeks (phased) |

---

## Priority Gaps

### P1: High Priority

#### GAP-PAPERTRAIL-002: execution-log.json Schema Missing
**Current State:** No schema exists in Papertrail
**Target State:** execution-log-json-schema.json created + ExecutionLogValidator
**Effort:** 4 hours
**Complexity:** Moderate

**Rationale:**
execution-log.json tracks task execution history for plan.json tasks. **Critical for resuming interrupted workflows** and tracking progress. Without schema validation, execution logs can become corrupted, breaking workflow resumption.

**Required Fields:**
- `workorder_id` (WO-{CATEGORY}-{ID}-### format)
- `feature_id` (kebab-case)
- `started_at` (ISO 8601 timestamp)
- `tasks` (array of task execution records)
- `status` (enum: in_progress, completed, failed)

**Tasks Structure:**
- `task_id` (must reference valid plan.json task)
- `started_at`, `status` (required)
- `completed_at`, `error`, `notes` (optional)
- Status enum: pending, in_progress, completed, failed, skipped

**Validation Checks:**
- Workorder ID format validation
- Feature ID format (kebab-case)
- Status enum validation
- Tasks array structure
- **Cross-validation:** task_id references must exist in corresponding plan.json
- Timestamps must be ISO 8601 format

**Blockers:** None
**Dependencies:**
- Need sample execution-log.json files from coderef-workflow to finalize structure
- Should reference plan.json task IDs for cross-validation

**Recommendation:** **CREATE schema immediately.** Execution logs are critical for workflow reliability.

---

### P2: Medium Priority

#### GAP-PAPERTRAIL-001: analysis.json Schema Missing
**Current State:** No schema exists in Papertrail
**Target State:** analysis-json-schema.json created + AnalysisValidator
**Effort:** 4 hours
**Complexity:** Moderate

**Rationale:**
analysis.json contains structured project analysis data generated by `analyze_project_for_planning`. AI agents read this data to inform planning decisions. Schema validation ensures consistent structure and prevents malformed analysis from breaking planning workflows.

**File Contents:**
- `project_type`, `tech_stack`, `key_dependencies`
- `project_structure`, `file_inventory`, `patterns_detected`

**Required Fields:**
- `project_path` (string)
- `analyzed_at` (ISO 8601 timestamp)
- `project_type` (enum: greenfield, enhancement, refactor, bugfix)
- `tech_stack` (object with framework/library keys)
- `file_inventory` (array of file objects)
- `patterns_detected` (array of detected code patterns)

**Optional Fields:**
- `key_dependencies`, `project_structure`, `recommendations`, `workorder_id`

**Validation Checks:**
- Required fields presence
- project_type enum validation
- tech_stack is object with valid keys
- file_inventory is array of objects
- patterns_detected is array

**Blockers:** None
**Dependencies:**
- Need sample analysis.json files from coderef-workflow to understand actual structure

**Recommendation:** **CREATE schema.** Structured data consumed by planning tools requires validation for consistency.

---

#### GAP-PAPERTRAIL-004: ValidatorFactory Path Patterns Missing
**Current State:** 30+ path patterns, missing coderef-workflow outputs
**Target State:** Add patterns for analysis.json, execution-log.json
**Effort:** 1 hour
**Complexity:** Trivial

**Rationale:**
ValidatorFactory auto-detects document types using path patterns. Once new schemas are created, factory needs updated patterns to detect these files automatically.

**New Patterns Needed:**
```python
r".*/coderef/workorder/.*/analysis\.json$": "analysis"
r".*/coderef/workorder/.*/execution-log\.json$": "execution_log"
```

**Blockers:** None
**Dependencies:**
- GAP-PAPERTRAIL-001 (analysis.json schema must exist first)
- GAP-PAPERTRAIL-002 (execution-log.json schema must exist first)

**Recommendation:** **UPDATE ValidatorFactory** after schemas are created.

---

#### GAP-PAPERTRAIL-005: workorder-doc-frontmatter-schema.json Enum Review
**Current State:** Schema has doc_type enum: ['plan', 'deliverables', 'context', 'analysis', 'instructions']
**Target State:** Verify 'analysis' enum value is correct
**Effort:** 0.5 hours
**Complexity:** Trivial

**Rationale:**
workorder-doc-frontmatter-schema.json applies to DELIVERABLES.md, context.json, and analysis.json. Enum already includes 'analysis' value. Need to verify coderef-workflow uses correct doc_type='analysis' in frontmatter.

**Current Enum:** `["plan", "deliverables", "context", "analysis", "instructions"]`

**Blockers:** None
**Dependencies:** None

**Recommendation:** **REVIEW existing enum.** 'analysis' already present - verify coderef-workflow uses correct value.

---

### P3: Low Priority

#### GAP-PAPERTRAIL-003: risk-assessment.json Schema Decision
**Current State:** No schema exists in Papertrail
**Target State:** SKIP schema creation - refactor to use plan.json instead
**Effort:** 2 hours (if schema created, but recommend skipping)
**Complexity:** Trivial

**Rationale:**
risk-assessment.json stores risk analysis for workorders. However, plan.json already has section `2_risk_assessment` with comprehensive risk tracking (technical risks, scope risks, dependency risks with severity levels and mitigation strategies).

**Recommendation:** **SKIP schema creation.** Risk data belongs in plan.json. If coderef-workflow generates standalone risk-assessment.json, recommend refactoring to use plan.json section 2_risk_assessment instead. This avoids duplicate risk tracking and ensures single source of truth.

**Alternative (if separate file required):**
- Required fields: `workorder_id`, `assessed_at`, `risks` (array)
- Risk structure: `risk`, `severity` (enum), `mitigation`
- Effort: 2 hours

**Blockers:** None
**Dependencies:** Coordinate with coderef-workflow on risk tracking strategy

---

## Schema Creation Plan

### New Schemas to Create (2)

#### 1. analysis-json-schema.json
**Location:** `papertrail/schemas/workflow/`
**Priority:** P2
**Effort:** 4 hours

**Structure:**
```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://papertrail/schemas/workflow/analysis-json-schema.json",
  "title": "Project Analysis JSON Schema",
  "type": "object",
  "required": ["project_path", "analyzed_at", "project_type", "tech_stack", "file_inventory", "patterns_detected"],
  "properties": {
    "project_path": { "type": "string" },
    "analyzed_at": { "type": "string", "format": "date-time" },
    "project_type": { "enum": ["greenfield", "enhancement", "refactor", "bugfix"] },
    "tech_stack": { "type": "object" },
    "file_inventory": { "type": "array" },
    "patterns_detected": { "type": "array" }
  }
}
```

**Validator Class:** `AnalysisValidator`
**Validator File:** `papertrail/validators/analysis.py`
**Extends:** None (standalone JSON schema, not markdown frontmatter)

**Validation Checks:**
- Required fields presence
- project_type enum validation
- tech_stack is object with valid keys
- file_inventory is array of objects
- patterns_detected is array

---

#### 2. execution-log-json-schema.json
**Location:** `papertrail/schemas/workflow/`
**Priority:** P1
**Effort:** 4 hours

**Structure:**
```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://papertrail/schemas/workflow/execution-log-json-schema.json",
  "title": "Execution Log JSON Schema",
  "type": "object",
  "required": ["workorder_id", "feature_id", "started_at", "tasks", "status"],
  "properties": {
    "workorder_id": { "type": "string", "pattern": "^WO-[A-Z0-9-]+-\\d{3}$" },
    "feature_id": { "type": "string", "pattern": "^[a-z0-9]+(-[a-z0-9]+)*$" },
    "started_at": { "type": "string", "format": "date-time" },
    "tasks": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["task_id", "started_at", "status"],
        "properties": {
          "task_id": { "type": "string" },
          "status": { "enum": ["pending", "in_progress", "completed", "failed", "skipped"] }
        }
      }
    },
    "status": { "enum": ["in_progress", "completed", "failed"] }
  }
}
```

**Validator Class:** `ExecutionLogValidator`
**Validator File:** `papertrail/validators/execution_log.py`
**Extends:** None (standalone JSON schema)

**Validation Checks:**
- Required fields presence
- Workorder ID format validation
- Feature ID format (kebab-case)
- Status enum validation
- Tasks array validation
- **Cross-validation:** task_id references must exist in corresponding plan.json
- Timestamps are ISO 8601 format

---

### Schemas to Skip (1)

#### risk-assessment-json-schema.json
**Reason:** Redundant - risk data belongs in plan.json section `2_risk_assessment`

**Recommendation:** Refactor coderef-workflow to use plan.json instead of standalone risk-assessment.json. This ensures:
- Single source of truth for risk tracking
- Risk data co-located with implementation plan
- No duplication between risk-assessment.json and plan.json

---

## Other Improvements

### IMP-001: Cross-Validation Between Execution Logs and Plans
**Priority:** P2
**Effort:** 2.5 hours

**Description:**
ExecutionLogValidator should verify `task_id` references exist in corresponding plan.json file. This prevents orphaned task IDs in execution logs and ensures data integrity across workflow artifacts.

**Implementation:**
```python
# In ExecutionLogValidator.validate_specific()
plan_path = file_path.parent / "plan.json"
if plan_path.exists():
    plan_data = json.loads(plan_path.read_text())
    valid_task_ids = extract_task_ids(plan_data)
    for task in execution_log["tasks"]:
        if task["task_id"] not in valid_task_ids:
            errors.append(ValidationError(
                severity=ValidationSeverity.MAJOR,
                message=f"task_id '{task['task_id']}' not found in plan.json",
                field="tasks"
            ))
```

**Benefit:** Prevents execution log corruption, ensures task tracking integrity.

---

### IMP-002: Add INFO Severity Level
**Priority:** P3
**Effort:** 1 hour

**Description:**
Current severities: CRITICAL, MAJOR, MINOR, WARNING. Add INFO for non-error messages like "Optional field recommended but not required."

**Rationale:**
Improves validator output clarity - separates actionable warnings from informational notes. INFO messages don't affect score calculation.

**Score Calculation Update:**
```python
# Current formula:
score = 100 - 50*CRITICAL - 20*MAJOR - 10*MINOR - 5*WARNING - 2*warnings

# Proposed: INFO messages don't affect score
score = 100 - 50*CRITICAL - 20*MAJOR - 10*MINOR - 5*WARNING - 2*warnings
# INFO messages displayed but not counted
```

---

### IMP-003: Create features-inventory.json Schema
**Priority:** P3
**Effort:** 2 hours

**Description:**
`generate_features_inventory` tool creates features-inventory.json. Should have schema to validate structure.

**Rationale:**
Low priority - features inventory is primarily for human consumption, less critical for automation. Can defer to Phase 4 if needed.

---

## Migration Plan

### Deprecated Components
None - these are new schemas, no existing validation to break.

### New Integrations
1. **AnalysisValidator** for analysis.json
2. **ExecutionLogValidator** for execution-log.json

### Breaking Changes
None - new schemas don't affect existing validators.

### Rollout Strategy
**Phased rollout:**
1. **Phase 2 (Current):** Gap analysis complete, schemas designed
2. **Phase 3a:** Create schemas (analysis.json, execution-log.json)
3. **Phase 3b:** Create validators (AnalysisValidator, ExecutionLogValidator)
4. **Phase 3c:** Update ValidatorFactory patterns
5. **Phase 3d:** Integrate validators into coderef-workflow generators (separate workorder)

---

## Blockers and Dependencies

### Blockers
- **Need sample files from coderef-workflow** to understand actual structure of analysis.json and execution-log.json
  - Request: coderef-workflow provides 2-3 example analysis.json files
  - Request: coderef-workflow provides 2-3 example execution-log.json files

### Dependencies
- coderef-workflow must provide sample analysis.json files for schema design
- coderef-workflow must provide sample execution-log.json files for schema design
- Phase 3 implementation depends on coderef-workflow adopting new schemas

### Coordination Needed
- Coordinate with coderef-workflow agent on analysis.json structure
- Coordinate with coderef-workflow agent on execution-log.json structure
- Confirm risk-assessment.json usage - should it remain or be deprecated?

---

## Recommendations

### High Priority
1. **Create execution-log-json-schema.json (P1)** - Critical for workflow resumption
2. **Create analysis-json-schema.json (P2)** - Ensures consistent project analysis

### Medium Priority
3. **Update ValidatorFactory patterns (P2)** for new schemas
4. **Add cross-validation (P2)** between execution logs and plans

### Low Priority
5. **Skip risk-assessment schema (P3)** - Refactor to use plan.json instead
6. **Add INFO severity level (P3)** - Improves output clarity
7. **Create features-inventory schema (P3)** - Defer if needed

---

## Impact Assessment

### Validation Rate Increase
**Minimal direct impact** - These are new schemas for previously unvalidated files. Enables coderef-workflow to achieve higher validation rate in Phase 3.

**Projected Increase:**
- Current: 6/50 outputs validated (12%)
- After Phase 3 integration: 9/50 outputs validated (+3 files = 18%)

### Quality Improvement
**High impact** - Execution logs and analysis files are critical workflow artifacts. Validation prevents data corruption and ensures workflow reliability.

**Benefits:**
- Workflow resumption reliability (execution logs)
- Consistent project analysis structure
- Data integrity across workflow artifacts
- Single source of truth for risk tracking

### Effort vs Benefit
**Moderate effort (14 hours) for high benefit** - Establishes validation for workflow-critical files.

**Breakdown:**
- 8 hours: Schema + validator creation (2 schemas)
- 3.5 hours: ValidatorFactory updates + cross-validation
- 2.5 hours: Other improvements (INFO severity, etc.)

---

## Next Steps for Phase 3

### Papertrail Tasks (WO-PAPERTRAIL-SCHEMA-ADDITIONS-001)
1. Create `analysis-json-schema.json` (4 hours)
2. Create `execution-log-json-schema.json` (4 hours)
3. Create `AnalysisValidator` (included in schema effort)
4. Create `ExecutionLogValidator` (included in schema effort)
5. Update `ValidatorFactory` patterns (1 hour)
6. Add cross-validation logic (2.5 hours)
7. Test new validators (2 hours)

**Total Effort:** 13.5 hours (~2 weeks at 40% allocation)

### Coderef-Workflow Tasks (Separate Workorder)
1. Integrate `AnalysisValidator` into `analyze_project_for_planning`
2. Integrate `ExecutionLogValidator` into `execute_plan`
3. Update generators to call validators
4. Test integration end-to-end

**Dependencies:** Must wait for Papertrail schema creation.

---

**Generated by:** papertrail agent
**Session:** WO-PAPERTRAIL-UDS-ALIGNMENT-002
**Phase:** Phase 2 - Gap Analysis
**Date:** 2026-01-10
