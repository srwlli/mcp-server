{
  "agent_id": "papertrail",
  "timestamp": "2026-01-10T13:00:00-05:00",
  "phase": "Phase 2: Gap Analysis",
  "summary": {
    "total_gaps": 5,
    "p0_gaps": 0,
    "p1_gaps": 1,
    "p2_gaps": 3,
    "p3_gaps": 1,
    "total_effort_hours": 14,
    "estimated_timeline": "1-2 weeks (phased rollout)"
  },
  "gaps": [
    {
      "gap_id": "GAP-PAPERTRAIL-001",
      "tool_or_file": "analysis.json (coderef-workflow)",
      "current_state": "No schema exists in Papertrail",
      "target_state": "analysis-json-schema.json created + AnalysisValidator",
      "priority": "P2",
      "complexity": "moderate",
      "effort_hours": 4,
      "rationale": "analysis.json contains structured project analysis data generated by analyze_project_for_planning. Should have schema to enforce consistent structure for AI agents reading this data. Contains: project_type, tech_stack, key_dependencies, project_structure, file_inventory, patterns_detected.",
      "required_fields": [
        "project_path",
        "analyzed_at",
        "project_type",
        "tech_stack",
        "file_inventory",
        "patterns_detected"
      ],
      "optional_fields": [
        "key_dependencies",
        "project_structure",
        "recommendations"
      ],
      "blockers": [],
      "dependencies": [
        "Need sample analysis.json files from coderef-workflow to understand actual structure"
      ],
      "recommendation": "Create schema. This is structured data consumed by planning tools - validation ensures consistency."
    },
    {
      "gap_id": "GAP-PAPERTRAIL-002",
      "tool_or_file": "execution-log.json (coderef-workflow)",
      "current_state": "No schema exists in Papertrail",
      "target_state": "execution-log-json-schema.json created + ExecutionLogValidator",
      "priority": "P1",
      "complexity": "moderate",
      "effort_hours": 4,
      "rationale": "execution-log.json tracks task execution history for plan.json tasks. Critical for resuming interrupted workflows and tracking progress. Should have schema to enforce task_id references and status tracking. Contains: workorder_id, tasks executed, timestamps, status changes, errors.",
      "required_fields": [
        "workorder_id",
        "feature_id",
        "started_at",
        "tasks",
        "status"
      ],
      "optional_fields": [
        "completed_at",
        "errors",
        "warnings"
      ],
      "tasks_structure": {
        "required": ["task_id", "started_at", "status"],
        "optional": ["completed_at", "error", "notes"]
      },
      "blockers": [],
      "dependencies": [
        "Need sample execution-log.json files from coderef-workflow",
        "Should reference plan.json task IDs for validation"
      ],
      "recommendation": "Create schema. Execution logs are critical for workflow resumption - schema prevents data corruption."
    },
    {
      "gap_id": "GAP-PAPERTRAIL-003",
      "tool_or_file": "risk-assessment.json (coderef-workflow)",
      "current_state": "No schema exists in Papertrail",
      "target_state": "risk-assessment-json-schema.json created + RiskAssessmentValidator OR remain unstructured",
      "priority": "P3",
      "complexity": "trivial",
      "effort_hours": 2,
      "rationale": "risk-assessment.json stores risk analysis for workorders. However, risk assessments are already in plan.json section 2_risk_assessment. Creating separate schema may be redundant. Recommend: SKIP schema creation, embed in plan.json validation instead.",
      "required_fields_if_created": [
        "workorder_id",
        "assessed_at",
        "risks"
      ],
      "blockers": [],
      "dependencies": [],
      "recommendation": "SKIP schema creation. Risk data belongs in plan.json. If coderef-workflow generates standalone risk-assessment.json, recommend refactoring to use plan.json instead."
    },
    {
      "gap_id": "GAP-PAPERTRAIL-004",
      "tool_or_file": "ValidatorFactory path patterns",
      "current_state": "30+ path patterns, missing some coderef-workflow outputs",
      "target_state": "Add patterns for analysis.json, execution-log.json, features-inventory.json",
      "priority": "P2",
      "complexity": "trivial",
      "effort_hours": 1,
      "rationale": "ValidatorFactory needs updated patterns to auto-detect new file types once schemas are created. Current patterns cover foundation docs, workorder docs, sessions, but missing workflow-specific JSON files.",
      "new_patterns_needed": [
        "r\".*/coderef/workorder/.*/analysis\\.json$\": \"analysis\"",
        "r\".*/coderef/workorder/.*/execution-log\\.json$\": \"execution_log\"",
        "r\".*/coderef/features-inventory\\.json$\": \"features_inventory\""
      ],
      "blockers": [],
      "dependencies": [
        "GAP-PAPERTRAIL-001 (analysis.json schema)",
        "GAP-PAPERTRAIL-002 (execution-log.json schema)"
      ],
      "recommendation": "Update ValidatorFactory patterns after schemas are created."
    },
    {
      "gap_id": "GAP-PAPERTRAIL-005",
      "tool_or_file": "workorder-doc-frontmatter-schema.json",
      "current_state": "Schema applies to DELIVERABLES.md, context.json, analysis.json but doc_type enum missing 'analysis'",
      "target_state": "Update doc_type enum to include 'analysis' value",
      "priority": "P2",
      "complexity": "trivial",
      "effort_hours": 0.5,
      "rationale": "workorder-doc-frontmatter-schema.json has doc_type enum: ['plan', 'deliverables', 'context', 'analysis', 'instructions']. Currently 'analysis' is present. Verify context.json uses correct doc_type value.",
      "current_enum": ["plan", "deliverables", "context", "analysis", "instructions"],
      "blockers": [],
      "dependencies": [],
      "recommendation": "Review existing enum - 'analysis' already present. No changes needed unless coderef-workflow uses different value."
    }
  ],
  "schema_creation_plan": {
    "new_schemas_needed": 2,
    "schemas_to_create": [
      {
        "schema_name": "analysis-json-schema.json",
        "location": "papertrail/schemas/workflow/",
        "priority": "P2",
        "effort_hours": 4,
        "structure": {
          "required": [
            "project_path",
            "analyzed_at",
            "project_type",
            "tech_stack",
            "file_inventory",
            "patterns_detected"
          ],
          "optional": [
            "key_dependencies",
            "project_structure",
            "recommendations",
            "workorder_id"
          ],
          "enums": {
            "project_type": ["greenfield", "enhancement", "refactor", "bugfix"]
          }
        },
        "validator_class": "AnalysisValidator",
        "validator_file": "papertrail/validators/analysis.py",
        "extends": "None (standalone JSON schema, not markdown frontmatter)",
        "validation_checks": [
          "Required fields presence",
          "project_type enum validation",
          "tech_stack is object with valid keys",
          "file_inventory is array of objects",
          "patterns_detected is array"
        ]
      },
      {
        "schema_name": "execution-log-json-schema.json",
        "location": "papertrail/schemas/workflow/",
        "priority": "P1",
        "effort_hours": 4,
        "structure": {
          "required": [
            "workorder_id",
            "feature_id",
            "started_at",
            "tasks",
            "status"
          ],
          "optional": [
            "completed_at",
            "errors",
            "warnings"
          ],
          "tasks_structure": {
            "required": ["task_id", "started_at", "status"],
            "optional": ["completed_at", "error", "notes"],
            "status_enum": ["pending", "in_progress", "completed", "failed", "skipped"]
          },
          "status_enum": ["in_progress", "completed", "failed"]
        },
        "validator_class": "ExecutionLogValidator",
        "validator_file": "papertrail/validators/execution_log.py",
        "extends": "None (standalone JSON schema)",
        "validation_checks": [
          "Required fields presence",
          "workorder_id format (WO-{CATEGORY}-{ID}-###)",
          "feature_id format (kebab-case)",
          "status enum validation",
          "tasks array validation",
          "task_id references valid plan.json tasks (cross-validation)",
          "timestamps are ISO 8601 format"
        ]
      }
    ],
    "schemas_to_skip": [
      {
        "schema_name": "risk-assessment-json-schema.json",
        "reason": "Redundant - risk data belongs in plan.json section 2_risk_assessment",
        "recommendation": "Refactor coderef-workflow to use plan.json instead of standalone risk-assessment.json"
      }
    ]
  },
  "validator_updates": {
    "validator_factory_updates": {
      "file": "papertrail/validators/factory.py",
      "new_patterns": {
        "analysis.json": "r\".*/coderef/workorder/.*/analysis\\.json$\": \"analysis\"",
        "execution-log.json": "r\".*/coderef/workorder/.*/execution-log\\.json$\": \"execution_log\""
      },
      "effort_hours": 1
    },
    "existing_validators_to_update": []
  },
  "migration_plan": {
    "deprecated_components": [],
    "new_integrations": [
      "AnalysisValidator for analysis.json",
      "ExecutionLogValidator for execution-log.json"
    ],
    "breaking_changes": [
      "None - these are new schemas, no existing validation to break"
    ],
    "rollout_strategy": "Phased: Create schemas → Update ValidatorFactory → Update coderef-workflow generators (Phase 3)"
  },
  "other_improvements": {
    "improvement_1": {
      "id": "IMP-001",
      "title": "Add cross-validation between execution-log.json and plan.json",
      "description": "ExecutionLogValidator should verify task_id references exist in corresponding plan.json file",
      "priority": "P2",
      "effort_hours": 2.5,
      "rationale": "Prevents orphaned task IDs in execution logs - ensures data integrity across workflow artifacts"
    },
    "improvement_2": {
      "id": "IMP-002",
      "title": "Add severity level for 'INFO' (non-blocking informational messages)",
      "description": "Current severities: CRITICAL, MAJOR, MINOR, WARNING. Add INFO for non-error messages like 'Optional field recommended but not required'",
      "priority": "P3",
      "effort_hours": 1,
      "rationale": "Improves validator output clarity - separates actionable warnings from informational notes"
    },
    "improvement_3": {
      "id": "IMP-003",
      "title": "Create features-inventory.json schema",
      "description": "generate_features_inventory tool creates features-inventory.json. Should have schema to validate structure.",
      "priority": "P3",
      "effort_hours": 2,
      "rationale": "Low priority - features inventory is primarily for human consumption, less critical for automation"
    }
  },
  "blockers_and_dependencies": {
    "blockers": [
      "Need sample files from coderef-workflow to understand actual structure of analysis.json and execution-log.json"
    ],
    "dependencies": [
      "coderef-workflow must provide sample analysis.json files for schema design",
      "coderef-workflow must provide sample execution-log.json files for schema design",
      "Phase 3 implementation depends on coderef-workflow adopting new schemas"
    ],
    "coordination_needed": [
      "Coordinate with coderef-workflow agent on analysis.json structure",
      "Coordinate with coderef-workflow agent on execution-log.json structure",
      "Confirm risk-assessment.json usage - should it remain or be deprecated?"
    ]
  },
  "recommendations": {
    "high_priority": [
      "Create execution-log-json-schema.json (P1) - Critical for workflow resumption",
      "Create analysis-json-schema.json (P2) - Ensures consistent project analysis"
    ],
    "medium_priority": [
      "Update ValidatorFactory patterns for new schemas (P2)",
      "Add cross-validation between execution logs and plans (P2)"
    ],
    "low_priority": [
      "Skip risk-assessment schema - refactor to use plan.json instead (P3)",
      "Add INFO severity level (P3)",
      "Create features-inventory schema (P3)"
    ]
  },
  "impact_assessment": {
    "validation_rate_increase": "Minimal direct impact - these are new schemas for previously unvalidated files. Enables coderef-workflow to achieve higher validation rate in Phase 3.",
    "quality_improvement": "High - execution logs and analysis files are critical workflow artifacts. Validation prevents data corruption and ensures workflow reliability.",
    "effort_vs_benefit": "Moderate effort (14 hours) for high benefit - establishes validation for workflow-critical files."
  }
}
